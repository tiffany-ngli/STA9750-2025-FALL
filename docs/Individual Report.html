<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.21">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Tiffany Ng Li">

<title>Transportation Accessibility &amp; Ridership - Individual Report – STA 9750 Submission Material</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-ea1d7ac60288e0f1efdbc993fd8432ae.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-76c7e95723c59cbc01dc74e89f55a0ab.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<link href="site_libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">
<script src="site_libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="site_libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="site_libs/datatables-binding-0.34.0/datatables.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="site_libs/dt-core-1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="site_libs/dt-core-1.13.6/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="site_libs/dt-core-1.13.6/js/jquery.dataTables.min.js"></script>
<link href="site_libs/crosstalk-1.2.2/css/crosstalk.min.css" rel="stylesheet">
<script src="site_libs/crosstalk-1.2.2/js/crosstalk.min.js"></script>


</head>

<body class="nav-fixed fullcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="./index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">STA 9750 Submission Material</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="././mp01.html"> 
<span class="menu-text">MP#01</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="././mp02.html"> 
<span class="menu-text">MP#02</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="././mp03.html"> 
<span class="menu-text">MP#03</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="././mp04.html"> 
<span class="menu-text">MP#04</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Transportation Accessibility &amp; Ridership - Individual Report</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Tiffany Ng Li </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<p><a href="https://tiffany-ngli.github.io/STA9750-2025-FALL/Summary%20Report.html">Overarching Question</a>: Did COVID-19 reshape the relationship between neighborhood characteristics and property values across NYC’s 59 Community Districts?</p>
<section id="sq-did-the-relationship-between-transit-accessibility-ridership-levels-and-property-values-change-from-pre-covid-and-post-covid-across-nycs-community-districts" class="level3">
<h3 class="anchored" data-anchor-id="sq-did-the-relationship-between-transit-accessibility-ridership-levels-and-property-values-change-from-pre-covid-and-post-covid-across-nycs-community-districts">SQ: Did the relationship between transit accessibility, ridership levels, and property values change from pre-COVID and post-COVID across NYC’s Community Districts?</h3>
</section>
<section id="introduction" class="level1">
<h1>INTRODUCTION</h1>
<div class="cell">
<details class="code-fold">
<summary>Loading in Libraries</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#LOADING LIBRARIES</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(httr)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tmap)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rmapshaper)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(leaflet)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RColorBrewer)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(janitor)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jsonlite)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glue)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DT)</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra) </span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="data-sources-research-outline" class="level1">
<h1>DATA SOURCES &amp; RESEARCH OUTLINE</h1>
<p>Before we could begin any analysis, we needed to go on a scavenger hunt for data. The key feature to bear in mind is to be able to locate ridership back to community districts. The following linked data sources were used to complete this research, followed by the code used to read in csv files or webscrape the website for observations. To reiterate, the shared data sources to answer the Overarching Question were the shapefile for community districts and the rolling sales data for housing prices. Since we defined the pre-COVID era as 2017 to 2019 and the post-COVID era as 2018 to 2021, the functions also clean the observations accordingly.</p>
<p>Initially, observing MTA subway ridership was not enough to cover all 59 community districts, which was necessary for the final stage of the multilinear regression model. Notably, the issue was that there are simply no subway stations running in Staten Island, so the Staten Island Railroad (SIR) was used in substitution to determine the ridership count for the three Staten Island community districts. Although a limitation of the SIR data was that it did not account for ridership per district. To address this, the total ridership per year was split evenly between the post-COVID years. As for pre-COVID, there was only data recorded for 2019, making the contributions of SIR ridership zero for the years 2017 and 2018. To make up for lost numbers and precision for ridership counts within each community district, MTA bus ridership was taken into account for a thorough assessment.</p>
<section id="community-districts-housing-prices-data" class="level3">
<h3 class="anchored" data-anchor-id="community-districts-housing-prices-data">Community Districts &amp; Housing Prices Data</h3>
<p>Housing sale prices were reported by NYC’s Department of Finance, located at the Borough, Block, Lot (BBL) level, which were each house to its corresponding CD through Pluto, and finally matched back to the CD shapefile for its boundaries. <a href="https://www.nyc.gov/content/planning/pages/resources/datasets/community-districts">59 Community Districts</a></p>
<div class="cell">
<details class="code-fold">
<summary>Community District Boundaries by CD IDs</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>get_nyc_cd <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  rds_path <span class="ot">&lt;-</span> <span class="st">"data_clean/nycd_25c.rds"</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  cd_url  <span class="ot">&lt;-</span> <span class="st">"https://s-media.nyc.gov/agencies/dcp/assets/files/zip/data-tools/bytes/community-districts/nycd_25c.zip"</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  zip_path <span class="ot">&lt;-</span> <span class="st">"data_raw/nycd_25c.zip"</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  dir_out <span class="ot">&lt;-</span> <span class="st">"data_raw/nycd_25c"</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="st">"data_raw"</span>))  <span class="fu">dir.create</span>(<span class="st">"data_raw"</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="st">"data_clean"</span>)) <span class="fu">dir.create</span>(<span class="st">"data_clean"</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(dir_out)) {</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unzip</span>(zip_path, <span class="at">exdir =</span> dir_out)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  shp_path <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_out, <span class="at">pattern =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">.shp$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>]</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  cd_sf <span class="ot">&lt;-</span> <span class="fu">st_read</span>(shp_path, <span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="st">"EPSG:2263"</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">boro_cd =</span> <span class="fu">as.integer</span>(BoroCD),</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">boro_num =</span> <span class="fu">substr</span>(<span class="fu">sprintf</span>(<span class="st">"%03d"</span>, boro_cd), <span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">boro_abbr =</span> <span class="fu">case_when</span>(</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>        boro_num <span class="sc">==</span> <span class="st">"1"</span> <span class="sc">~</span> <span class="st">"MN"</span>,</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>        boro_num <span class="sc">==</span> <span class="st">"2"</span> <span class="sc">~</span> <span class="st">"BX"</span>,</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>        boro_num <span class="sc">==</span> <span class="st">"3"</span> <span class="sc">~</span> <span class="st">"BK"</span>,</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>        boro_num <span class="sc">==</span> <span class="st">"4"</span> <span class="sc">~</span> <span class="st">"QN"</span>,</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>        boro_num <span class="sc">==</span> <span class="st">"5"</span> <span class="sc">~</span> <span class="st">"SI"</span>,</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_character_</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">cd_num =</span> <span class="fu">sprintf</span>(<span class="st">"%02d"</span>, boro_cd <span class="sc">%%</span> <span class="dv">100</span>),</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">cd_id =</span> <span class="fu">paste0</span>(boro_abbr, cd_num)</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">as.integer</span>(cd_num) <span class="sc">&lt;=</span> <span class="dv">18</span>) <span class="co"># Keep only 59 standard CDs</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(cd_sf, rds_path)</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>  cd_sf</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>nyc_cd <span class="ot">&lt;-</span> <span class="fu">get_nyc_cd</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p><a href="https://www.nyc.gov/content/planning/pages/resources/datasets/mappluto-pluto-change">Pluto</a></p>
<div class="cell">
<details class="code-fold">
<summary>Links CD IDs to BBLs</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>get_pluto_cd_crosswalk <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  rds_path <span class="ot">&lt;-</span> <span class="st">"data_clean/pluto_cd_crosswalk.rds"</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="st">"data_clean"</span>)) <span class="fu">dir.create</span>(<span class="st">"data_clean"</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  pluto_url <span class="ot">&lt;-</span> <span class="st">"https://data.cityofnewyork.us/resource/64uk-42ks.csv?$select=bbl,cd&amp;$limit=5000000"</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  pluto_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    pluto_url,</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">col_types =</span> <span class="fu">cols</span>(<span class="at">bbl =</span> <span class="fu">col_character</span>(), <span class="at">cd =</span> <span class="fu">col_character</span>()),</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">show_col_types =</span> <span class="cn">FALSE</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  pluto_xwalk <span class="ot">&lt;-</span> pluto_raw <span class="sc">|&gt;</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(cd), cd <span class="sc">!=</span> <span class="st">"0"</span>, cd <span class="sc">!=</span> <span class="st">"99"</span>) <span class="sc">|&gt;</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">bbl =</span> <span class="fu">str_replace</span>(bbl, <span class="st">"</span><span class="sc">\\</span><span class="st">.0+$"</span>, <span class="st">""</span>),</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">boro_cd =</span> <span class="fu">as.integer</span>(cd)</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">nchar</span>(bbl) <span class="sc">==</span> <span class="dv">10</span>) <span class="sc">|&gt;</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(bbl, boro_cd)</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>  cd_lookup <span class="ot">&lt;-</span> <span class="fu">get_nyc_cd</span>() <span class="sc">|&gt;</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_drop_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(boro_cd, cd_id) <span class="sc">|&gt;</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>()</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>  crosswalk <span class="ot">&lt;-</span> pluto_xwalk <span class="sc">|&gt;</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(cd_lookup, <span class="at">by =</span> <span class="st">"boro_cd"</span>) <span class="sc">|&gt;</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(cd_id)) <span class="sc">|&gt;</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>(bbl, cd_id, boro_cd)</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># SANITY CHECK #2: Crosswalk coverage</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>  n_cds_in_xwalk <span class="ot">&lt;-</span> <span class="fu">n_distinct</span>(crosswalk<span class="sc">$</span>cd_id)</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (n_cds_in_xwalk <span class="sc">!=</span> <span class="dv">59</span>) {</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">" SANITY CHECK WARNING: PLUTO crosswalk covers "</span>, n_cds_in_xwalk, <span class="st">" CDs (expected 59)"</span>)</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"✓ SANITY CHECK PASSED: PLUTO crosswalk covers all 59 CDs"</span>)</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(crosswalk, rds_path)</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>  crosswalk</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a><span class="co"># pluto_xwalk &lt;- get_pluto_cd_crosswalk()</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p><a href="https://www.nyc.gov/site/finance/about/open-portal.page">NYC Annual Property Value Sales Data</a></p>
<div class="cell">
<details class="code-fold">
<summary>Housing Prices by BBLs</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>get_dof_sales_year_boro <span class="ot">&lt;-</span> <span class="cf">function</span>(year, borough_name) {</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  cache_file <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"data_clean/dof_{year}_{borough_name}.rds"</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">file.exists</span>(cache_file)) {</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">readRDS</span>(cache_file))</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  valid_boroughs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"manhattan"</span>, <span class="st">"bronx"</span>, <span class="st">"brooklyn"</span>, <span class="st">"queens"</span>, <span class="st">"staten_island"</span>)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>borough_name <span class="sc">%in%</span> valid_boroughs) {</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Invalid borough: "</span>, borough_name)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  base_url <span class="ot">&lt;-</span> <span class="st">"https://www.nyc.gov/assets/finance/downloads/pdf/rolling_sales/annualized-sales"</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  ext <span class="ot">&lt;-</span> <span class="cf">if</span> (year <span class="sc">==</span> <span class="dv">2017</span>) <span class="st">"xls"</span> <span class="cf">else</span> <span class="st">"xlsx"</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  slug_primary <span class="ot">&lt;-</span> <span class="cf">if</span> (borough_name <span class="sc">==</span> <span class="st">"staten_island"</span>) <span class="st">"staten_island"</span> <span class="cf">else</span> borough_name</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  slug_alt <span class="ot">&lt;-</span> <span class="cf">if</span> (borough_name <span class="sc">==</span> <span class="st">"staten_island"</span>) <span class="st">"statenisland"</span> <span class="cf">else</span> borough_name</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  url_primary <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{base_url}/{year}/{year}_{slug_primary}.{ext}"</span>)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  url_alt <span class="ot">&lt;-</span> <span class="cf">if</span> (slug_alt <span class="sc">!=</span> slug_primary) <span class="fu">glue</span>(<span class="st">"{base_url}/{year}/{year}_{slug_alt}.{ext}"</span>) <span class="cf">else</span> <span class="cn">NA_character_</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="st">"data_raw"</span>)) <span class="fu">dir.create</span>(<span class="st">"data_raw"</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  file_path <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"data_raw/dof_sales_{year}_{borough_name}.{ext}"</span>)</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(file_path)) {</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    download_ok <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">try</span>({</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">download.file</span>(url_primary, file_path, <span class="at">mode =</span> <span class="st">"wb"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>      download_ok <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span>download_ok <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(url_alt)) {</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>      <span class="fu">try</span>({</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>        <span class="fu">download.file</span>(url_alt, file_path, <span class="at">mode =</span> <span class="st">"wb"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>        download_ok <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>      }, <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span>download_ok) {</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>      <span class="fu">warning</span>(<span class="st">"Failed to download: "</span>, year, <span class="st">" "</span>, borough_name)</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>  preview <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(file_path, <span class="at">col_names =</span> <span class="cn">FALSE</span>, <span class="at">n_max =</span> <span class="dv">20</span>)</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>  header_row <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">apply</span>(preview, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">any</span>(<span class="fu">grepl</span>(<span class="st">"BOROUGH"</span>, x, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>))))</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(header_row) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">"Could not detect header: "</span>, year, <span class="st">" "</span>, borough_name)</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>  skip_rows <span class="ot">&lt;-</span> header_row[<span class="dv">1</span>] <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>  raw_sales <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(<span class="fu">read_excel</span>(file_path, <span class="at">skip =</span> skip_rows)) <span class="sc">|&gt;</span></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">clean_names</span>()</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(raw_sales) <span class="sc">==</span> <span class="dv">0</span>L) {</span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">"No data rows: "</span>, year, <span class="st">" "</span>, borough_name)</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>  required_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"borough"</span>, <span class="st">"block"</span>, <span class="st">"lot"</span>, <span class="st">"sale_price"</span>, <span class="st">"sale_date"</span>)</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>  missing_cols <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(required_cols, <span class="fu">names</span>(raw_sales))</span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(missing_cols) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">"Missing columns: "</span>, <span class="fu">paste</span>(missing_cols, <span class="at">collapse =</span> <span class="st">", "</span>))</span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>  sales_clean <span class="ot">&lt;-</span> raw_sales <span class="sc">|&gt;</span></span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>      <span class="at">block =</span> <span class="fu">suppressWarnings</span>(<span class="fu">as.integer</span>(block)),</span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>      <span class="at">lot =</span> <span class="fu">suppressWarnings</span>(<span class="fu">as.integer</span>(lot)),</span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>      <span class="at">sale_price =</span> <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(sale_price)),</span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>      <span class="at">gross_square_feet =</span> <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(gross_square_feet)),</span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>      <span class="at">sale_date =</span> <span class="fu">suppressWarnings</span>(<span class="fu">case_when</span>(</span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>        <span class="fu">inherits</span>(sale_date, <span class="fu">c</span>(<span class="st">"Date"</span>, <span class="st">"POSIXct"</span>, <span class="st">"POSIXt"</span>)) <span class="sc">~</span> <span class="fu">as.Date</span>(sale_date),</span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>        <span class="fu">is.numeric</span>(sale_date) <span class="sc">~</span> <span class="fu">as.Date</span>(sale_date, <span class="at">origin =</span> <span class="st">"1899-12-30"</span>),</span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>        <span class="fu">is.character</span>(sale_date) <span class="sc">~</span> <span class="fu">mdy</span>(sale_date),</span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fu">as.Date</span>(<span class="cn">NA</span>)</span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>      )),</span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>      <span class="at">borough_code =</span> <span class="fu">case_when</span>(</span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>        borough_name <span class="sc">==</span> <span class="st">"manhattan"</span> <span class="sc">~</span> <span class="st">"1"</span>,</span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>        borough_name <span class="sc">==</span> <span class="st">"bronx"</span>  <span class="sc">~</span> <span class="st">"2"</span>,</span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>        borough_name <span class="sc">==</span> <span class="st">"brooklyn"</span> <span class="sc">~</span> <span class="st">"3"</span>,</span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>        borough_name <span class="sc">==</span> <span class="st">"queens"</span> <span class="sc">~</span> <span class="st">"4"</span>,</span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>        borough_name <span class="sc">==</span> <span class="st">"staten_island"</span> <span class="sc">~</span> <span class="st">"5"</span></span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>      <span class="at">bbl =</span> <span class="fu">paste0</span>(</span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>        borough_code,</span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_pad</span>(block, <span class="dv">5</span>, <span class="at">pad =</span> <span class="st">"0"</span>),</span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_pad</span>(lot, <span class="dv">4</span>, <span class="at">pad =</span> <span class="st">"0"</span>)</span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>  tax_class_candidates <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a>    <span class="st">"tax_class_at_time_of_sale"</span>,</span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a>    <span class="st">"tax_class_at_present"</span>,</span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a>    <span class="st">"tax_class_at_time_of_sale_2"</span>,</span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a>    <span class="st">"tax_class"</span></span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a>  tax_class_col <span class="ot">&lt;-</span> tax_class_candidates[tax_class_candidates <span class="sc">%in%</span> <span class="fu">names</span>(sales_clean)][<span class="dv">1</span>]</span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(tax_class_col)) {</span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">"No tax_class column: "</span>, year, <span class="st">" "</span>, borough_name)</span>
<span id="cb4-112"><a href="#cb4-112" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb4-113"><a href="#cb4-113" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-114"><a href="#cb4-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-115"><a href="#cb4-115" aria-hidden="true" tabindex="-1"></a>  sales_clean <span class="ot">&lt;-</span> sales_clean <span class="sc">|&gt;</span></span>
<span id="cb4-116"><a href="#cb4-116" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">tax_class =</span> <span class="fu">str_trim</span>(<span class="fu">as.character</span>(.data[[tax_class_col]])))</span>
<span id="cb4-117"><a href="#cb4-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-118"><a href="#cb4-118" aria-hidden="true" tabindex="-1"></a>  sales_clean <span class="ot">&lt;-</span> sales_clean <span class="sc">|&gt;</span></span>
<span id="cb4-119"><a href="#cb4-119" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(</span>
<span id="cb4-120"><a href="#cb4-120" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">is.na</span>(bbl),</span>
<span id="cb4-121"><a href="#cb4-121" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">is.na</span>(sale_price),</span>
<span id="cb4-122"><a href="#cb4-122" aria-hidden="true" tabindex="-1"></a>      sale_price <span class="sc">&gt;=</span> <span class="dv">10000</span>,</span>
<span id="cb4-123"><a href="#cb4-123" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">is.na</span>(sale_date),</span>
<span id="cb4-124"><a href="#cb4-124" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">is.na</span>(tax_class),</span>
<span id="cb4-125"><a href="#cb4-125" aria-hidden="true" tabindex="-1"></a>      tax_class <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"1"</span>, <span class="st">"2"</span>, <span class="st">"2A"</span>, <span class="st">"2B"</span>, <span class="st">"2C"</span>)</span>
<span id="cb4-126"><a href="#cb4-126" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb4-127"><a href="#cb4-127" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(bbl, sale_price, sale_date, gross_square_feet, tax_class, borough_code, block, lot)</span>
<span id="cb4-128"><a href="#cb4-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-129"><a href="#cb4-129" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="st">"data_clean"</span>)) <span class="fu">dir.create</span>(<span class="st">"data_clean"</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-130"><a href="#cb4-130" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(sales_clean, cache_file)</span>
<span id="cb4-131"><a href="#cb4-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-132"><a href="#cb4-132" aria-hidden="true" tabindex="-1"></a>  sales_clean</span>
<span id="cb4-133"><a href="#cb4-133" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Joining Housing Prices to CDs</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>build_cd_sales_panel <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">pre_years =</span> <span class="dv">2017</span><span class="sc">:</span><span class="dv">2019</span>, <span class="at">post_years =</span> <span class="dv">2021</span><span class="sc">:</span><span class="dv">2023</span>, <span class="at">pluto_xwalk =</span> <span class="cn">NULL</span>) {</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(pluto_xwalk)) {</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    pluto_xwalk <span class="ot">&lt;-</span> <span class="fu">get_pluto_cd_crosswalk</span>()</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  boroughs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"bronx"</span>, <span class="st">"brooklyn"</span>, <span class="st">"manhattan"</span>, <span class="st">"queens"</span>, <span class="st">"staten_island"</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create combinations for ALL years</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  combos <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">year =</span> <span class="fu">c</span>(pre_years, post_years),</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">borough =</span> boroughs</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(year, borough)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Download all sales data</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  sales_list <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, <span class="fu">nrow</span>(combos))</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(combos))) {</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    yr <span class="ot">&lt;-</span> combos<span class="sc">$</span>year[i]</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    bo <span class="ot">&lt;-</span> combos<span class="sc">$</span>borough[i]</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    sales <span class="ot">&lt;-</span> <span class="fu">get_dof_sales_year_boro</span>(yr, bo)</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(sales) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(sales) <span class="sc">&gt;</span> <span class="dv">0</span>L) {</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>      sales_list[[i]] <span class="ot">&lt;-</span> sales <span class="sc">|&gt;</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">year =</span> yr, <span class="at">borough =</span> bo)</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>  all_sales <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(sales_list)</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Exact BBL match</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>  sales_matched_exact <span class="ot">&lt;-</span> all_sales <span class="sc">|&gt;</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inner_join</span>(pluto_xwalk, <span class="at">by =</span> <span class="st">"bbl"</span>)</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>  n_exact <span class="ot">&lt;-</span> <span class="fu">nrow</span>(sales_matched_exact)</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Block-level matching for unmatched sales</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>  sales_unmatched <span class="ot">&lt;-</span> all_sales <span class="sc">|&gt;</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">anti_join</span>(pluto_xwalk, <span class="at">by =</span> <span class="st">"bbl"</span>)</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(sales_unmatched) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>    pluto_block_lookup <span class="ot">&lt;-</span> pluto_xwalk <span class="sc">|&gt;</span></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>        <span class="at">block =</span> <span class="fu">as.integer</span>(<span class="fu">substr</span>(bbl, <span class="dv">2</span>, <span class="dv">6</span>)),</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>        <span class="at">boro_digit =</span> <span class="fu">substr</span>(bbl, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>      <span class="fu">count</span>(boro_digit, block, cd_id, boro_cd) <span class="sc">|&gt;</span></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(boro_digit, block) <span class="sc">|&gt;</span></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>      <span class="fu">slice_max</span>(n, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">with_ties =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(boro_digit, block, cd_id, boro_cd)</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>    sales_matched_block <span class="ot">&lt;-</span> sales_unmatched <span class="sc">|&gt;</span></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">boro_digit =</span> <span class="fu">substr</span>(bbl, <span class="dv">1</span>, <span class="dv">1</span>)) <span class="sc">|&gt;</span></span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>      <span class="fu">inner_join</span>(pluto_block_lookup, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"boro_digit"</span>, <span class="st">"block"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span>boro_digit)</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>    n_block <span class="ot">&lt;-</span> <span class="fu">nrow</span>(sales_matched_block)</span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>    sales_with_cd <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(sales_matched_exact, sales_matched_block)</span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>    sales_with_cd <span class="ot">&lt;-</span> sales_matched_exact</span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>    n_block <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create period labels</span></span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>  sales_with_cd <span class="ot">&lt;-</span> sales_with_cd <span class="sc">|&gt;</span></span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>      <span class="at">period =</span> <span class="fu">case_when</span>(</span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>        year <span class="sc">%in%</span> pre_years <span class="sc">~</span> <span class="st">"pre_covid"</span>,</span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>        year <span class="sc">%in%</span> post_years <span class="sc">~</span> <span class="st">"post_covid"</span>,</span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_character_</span></span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(period))</span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate median price per CD per period (aggregating across all years in period)</span></span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>  cd_panel <span class="ot">&lt;-</span> sales_with_cd <span class="sc">|&gt;</span></span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(cd_id, boro_cd, period) <span class="sc">|&gt;</span></span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>      <span class="at">sales =</span> <span class="fu">n</span>(),</span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>      <span class="at">median_price =</span> <span class="fu">median</span>(sale_price, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_price =</span> <span class="fu">mean</span>(sale_price, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>      <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(</span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>      <span class="at">id_cols =</span> <span class="fu">c</span>(cd_id, boro_cd),</span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a>      <span class="at">names_from =</span> period,</span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a>      <span class="at">values_from =</span> <span class="fu">c</span>(sales, median_price, mean_price),</span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a>      <span class="at">names_glue =</span> <span class="st">"{.value}_{period}"</span></span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(</span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a>      <span class="at">median_sale_price_precovid =</span> median_price_pre_covid,</span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a>      <span class="at">median_sale_price_postcovid =</span> median_price_post_covid,</span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_sale_price_precovid =</span> mean_price_pre_covid,</span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_sale_price_postcovid =</span> mean_price_post_covid</span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(</span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a>      cd_id,</span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a>      boro_cd,</span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a>      sales_pre_covid,</span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a>      median_sale_price_precovid,</span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a>      mean_sale_price_precovid,</span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a>      sales_post_covid,</span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a>      median_sale_price_postcovid,</span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a>      mean_sale_price_postcovid</span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-108"><a href="#cb5-108" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-109"><a href="#cb5-109" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Statistics</span></span>
<span id="cb5-110"><a href="#cb5-110" aria-hidden="true" tabindex="-1"></a>  total_sales_all_files <span class="ot">&lt;-</span> <span class="fu">nrow</span>(all_sales)</span>
<span id="cb5-111"><a href="#cb5-111" aria-hidden="true" tabindex="-1"></a>  total_sales_matched <span class="ot">&lt;-</span> n_exact <span class="sc">+</span> n_block</span>
<span id="cb5-112"><a href="#cb5-112" aria-hidden="true" tabindex="-1"></a>  overall_match_rate <span class="ot">&lt;-</span> total_sales_matched <span class="sc">/</span> total_sales_all_files</span>
<span id="cb5-113"><a href="#cb5-113" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-114"><a href="#cb5-114" aria-hidden="true" tabindex="-1"></a>  cd_panel</span>
<span id="cb5-115"><a href="#cb5-115" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-116"><a href="#cb5-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-117"><a href="#cb5-117" aria-hidden="true" tabindex="-1"></a>cd_sales <span class="ot">&lt;-</span> <span class="fu">build_cd_sales_panel</span>(</span>
<span id="cb5-118"><a href="#cb5-118" aria-hidden="true" tabindex="-1"></a>  <span class="at">pre_years =</span> <span class="dv">2017</span><span class="sc">:</span><span class="dv">2019</span>,</span>
<span id="cb5-119"><a href="#cb5-119" aria-hidden="true" tabindex="-1"></a>  <span class="at">post_years =</span> <span class="dv">2021</span><span class="sc">:</span><span class="dv">2023</span></span>
<span id="cb5-120"><a href="#cb5-120" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="ridership-data" class="level3">
<h3 class="anchored" data-anchor-id="ridership-data">Ridership Data</h3>
<p>To summarize, the means of transportation observed include Subways, Buses, and the Staten Island Railroad, all of which are supported by the MTA. In addition to accounting for the ridership at each station, these stations were then located to their corresponding CD through its longitude and latitude coordinates.</p>
<p><a href="https://www.nyc.gov/site/finance/about/open-portal.page">Pre-COVID Subway Ridership</a></p>
<div class="cell">
<details class="code-fold">
<summary>Subway Ridership - (2017-2019)</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>subway_annual_data_2017_2022 <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">save_file =</span> <span class="cn">FALSE</span>, <span class="at">file_path =</span> <span class="st">"mta_ridership.xlsx"</span>) {</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># URL of the MTA Excel file</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  url <span class="ot">&lt;-</span> <span class="st">"https://www.mta.info/document/113331"</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a temporary file to store the download</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  temp_file <span class="ot">&lt;-</span> <span class="fu">tempfile</span>(<span class="at">fileext =</span> <span class="st">".xlsx"</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Download the file</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  response <span class="ot">&lt;-</span> <span class="fu">GET</span>(url, <span class="fu">write_disk</span>(temp_file, <span class="at">overwrite =</span> <span class="cn">TRUE</span>))</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get all sheet names</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  sheet_names <span class="ot">&lt;-</span> <span class="fu">excel_sheets</span>(temp_file)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Find the sheet with "annual" and "total" in the name (case-insensitive)</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  annual_sheet <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"annual.*total|total.*annual"</span>, sheet_names, </span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>                       <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(annual_sheet) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Could not find 'annual total' sheet. Available sheets: "</span>, </span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>         <span class="fu">paste</span>(sheet_names, <span class="at">collapse =</span> <span class="st">", "</span>))</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use the first match if multiple sheets found</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>  annual_sheet <span class="ot">&lt;-</span> annual_sheet[<span class="dv">1</span>]</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read the data from the annual total sheet</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(temp_file, <span class="at">sheet =</span> annual_sheet, <span class="at">skip=</span><span class="dv">1</span>)</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>  <span class="co">#clean data </span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">clean_names</span>() <span class="sc">|&gt;</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">str_remove</span>(., <span class="st">"^x(?=</span><span class="sc">\\</span><span class="st">d{4})"</span>), <span class="at">.cols =</span> <span class="fu">starts_with</span>(<span class="st">"x"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">station_name =</span> <span class="fu">str_trim</span>(<span class="fu">sub</span>(<span class="st">" </span><span class="sc">\\</span><span class="st">(.*$"</span>, <span class="st">""</span>, <span class="st">`</span><span class="at">station_alphabetical_by_borough</span><span class="st">`</span>))</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>station_alphabetical_by_borough <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"The Bronx"</span>, <span class="st">"Brooklyn"</span>, <span class="st">"Manhattan"</span>, <span class="st">"Queens"</span>, <span class="st">"Staten Island"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(station_name, station_alphabetical_by_borough, boro, <span class="st">`</span><span class="at">2017</span><span class="st">`</span>, <span class="st">`</span><span class="at">2018</span><span class="st">`</span>, <span class="st">`</span><span class="at">2019</span><span class="st">`</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(boro))</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data)</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>precovid_subway_ridership <span class="ot">&lt;-</span> <span class="fu">subway_annual_data_2017_2022</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p><a href="https://www.mta.info/agency/new-york-city-transit/subway-bus-ridership-2023">Post-COVID Subway Ridership</a></p>
<div class="cell">
<details class="code-fold">
<summary>Subway Ridership - (2021-2023)</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>subway_annual_data_2018_2023 <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">save_file =</span> <span class="cn">FALSE</span>, <span class="at">file_path =</span> <span class="st">"mta_ridership.xlsx"</span>) {</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># URL of the MTA Excel file</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  url <span class="ot">&lt;-</span> <span class="st">"https://www.mta.info/document/137106"</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a temporary file to store the download</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  temp_file <span class="ot">&lt;-</span> <span class="fu">tempfile</span>(<span class="at">fileext =</span> <span class="st">".xlsx"</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Download the file</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  response <span class="ot">&lt;-</span> <span class="fu">GET</span>(url, <span class="fu">write_disk</span>(temp_file, <span class="at">overwrite =</span> <span class="cn">TRUE</span>))</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get all sheet names</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  sheet_names <span class="ot">&lt;-</span> <span class="fu">excel_sheets</span>(temp_file)</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Find the sheet with "annual" and "total" in the name (case-insensitive)</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  annual_sheet <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"annual.*total|total.*annual"</span>, sheet_names, </span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>                       <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use the first match if multiple sheets found</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  annual_sheet <span class="ot">&lt;-</span> annual_sheet[<span class="dv">1</span>]</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read the data from the annual total sheet</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(temp_file, <span class="at">sheet =</span> annual_sheet, <span class="at">skip=</span><span class="dv">1</span>)</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>  <span class="co">#clean data </span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">clean_names</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">str_remove</span>(., <span class="st">"^x(?=</span><span class="sc">\\</span><span class="st">d{4})"</span>), <span class="at">.cols =</span> <span class="fu">starts_with</span>(<span class="st">"x"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">station_name =</span> <span class="fu">str_trim</span>(<span class="fu">sub</span>(<span class="st">" </span><span class="sc">\\</span><span class="st">(.*$"</span>, <span class="st">""</span>, <span class="st">`</span><span class="at">station_alphabetical_by_borough</span><span class="st">`</span>))</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>station_alphabetical_by_borough <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"The Bronx"</span>, <span class="st">"Brooklyn"</span>, <span class="st">"Manhattan"</span>, <span class="st">"Queens"</span>, <span class="st">"Staten Island"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(station_name, station_alphabetical_by_borough, boro, <span class="st">`</span><span class="at">2021</span><span class="st">`</span>, <span class="st">`</span><span class="at">2022</span><span class="st">`</span>, <span class="st">`</span><span class="at">2023</span><span class="st">`</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(boro))</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data)</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>postcovid_subway_ridership <span class="ot">&lt;-</span> <span class="fu">subway_annual_data_2018_2023</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p><a href="https://data.ny.gov/Transportation/MTA-Subway-Stations/39hk-dx4f/about_data">MTA Subway Station Geompoints</a></p>
<div class="cell">
<details class="code-fold">
<summary>Subway Station - Coordinates</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>get_mta_subway_stations <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(data.table)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(dplyr)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(sf)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># URL for MTA subway stations</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  url <span class="ot">&lt;-</span> <span class="st">"https://data.ny.gov/api/views/39hk-dx4f/rows.csv?accessType=DOWNLOAD"</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read data directly into df</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">fread</span>(url)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert Georeference to sf geometry</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  df_sf <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">geometry =</span> <span class="fu">st_as_sfc</span>(Georeference, <span class="at">crs =</span> <span class="dv">4326</span>)) <span class="sc">|&gt;</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_as_sf</span>(<span class="at">sf_column_name =</span> <span class="st">"geometry"</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">longitude =</span> <span class="fu">st_coordinates</span>(geometry)[, <span class="st">"X"</span>],</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">latitude  =</span> <span class="fu">st_coordinates</span>(geometry)[, <span class="st">"Y"</span>]</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="st">`</span><span class="at">Stop Name</span><span class="st">`</span>, geometry)</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transform CRS to match NYC (EPSG 2263 is commonly used for NYC local coordinates)</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>  df_sf <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(df_sf, <span class="at">crs =</span> <span class="dv">2263</span>)</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df_sf)</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>stations <span class="ot">&lt;-</span> <span class="fu">get_mta_subway_stations</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p><a href="https://www.mta.info/agency/new-york-city-transit/subway-bus-ridership-2022">Pre-COVID Bus Ridership</a></p>
<div class="cell">
<details class="code-fold">
<summary>Bus Ridership - (2017-2019)</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>bus_annual_data_2017_2022 <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">save_file =</span> <span class="cn">FALSE</span>, <span class="at">file_path =</span> <span class="st">"mta_ridership.xlsx"</span>) {</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># URL of the MTA Excel file</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  url <span class="ot">&lt;-</span> <span class="st">"https://www.mta.info/document/113336"</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a temporary file to store the download</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  temp_file <span class="ot">&lt;-</span> <span class="fu">tempfile</span>(<span class="at">fileext =</span> <span class="st">".xlsx"</span>)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Download the file</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  response <span class="ot">&lt;-</span> <span class="fu">GET</span>(url, <span class="fu">write_disk</span>(temp_file, <span class="at">overwrite =</span> <span class="cn">TRUE</span>))</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get all sheet names</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  sheet_names <span class="ot">&lt;-</span> <span class="fu">excel_sheets</span>(temp_file)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Find the sheet with "annual" and "total" in the name (case-insensitive)</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  annual_sheet <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"*total|total"</span>, sheet_names, </span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>                       <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(annual_sheet) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Could not find 'annual total' sheet. Available sheets: "</span>, </span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>         <span class="fu">paste</span>(sheet_names, <span class="at">collapse =</span> <span class="st">", "</span>))</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use the first match if multiple sheets found</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>  annual_sheet <span class="ot">&lt;-</span> annual_sheet[<span class="dv">1</span>]</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read the data from the annual total sheet</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(temp_file, <span class="at">sheet =</span> annual_sheet, <span class="at">skip=</span><span class="dv">1</span>)</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>  <span class="co">#clean data </span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="dv">2017</span>)) <span class="sc">|&gt;</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(Route, <span class="st">" "</span>)) <span class="sc">|&gt;</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span><span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">.</span><span class="sc">\\</span><span class="st">.</span><span class="sc">\\</span><span class="st">."</span>), <span class="sc">-</span><span class="fu">any_of</span>(<span class="st">"*"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^20</span><span class="sc">\\</span><span class="st">d{2}$"</span>), <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="fu">str_replace_all</span>(., <span class="st">","</span>, <span class="st">""</span>)))) <span class="sc">|&gt;</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>      <span class="at">Route =</span> <span class="fu">if_else</span>(<span class="fu">str_starts</span>(Route, <span class="st">"X"</span>),</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">str_replace</span>(Route, <span class="st">"^X"</span>, <span class="st">"SIM"</span>),</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>                      Route)</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(Route) <span class="sc">|&gt;</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>      <span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^20</span><span class="sc">\\</span><span class="st">d{2}$"</span>), <span class="sc">~</span> <span class="fu">sum</span>(., <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>      <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Route =</span> <span class="fu">str_extract</span>(Route, <span class="st">"^[A-Za-z]+[0-9]+"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Route, <span class="st">"2017"</span>, <span class="st">"2018"</span>, <span class="st">"2019"</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Route <span class="sc">!=</span> <span class="st">"Adjustments"</span>)</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clean up temp file</span></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unlink</span>(temp_file)</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data)</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>precovid_bus_ridership <span class="ot">&lt;-</span> <span class="fu">bus_annual_data_2017_2022</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p><a href="https://www.mta.info/agency/new-york-city-transit/subway-bus-ridership-2022">Post-COVID Bus Ridership</a></p>
<div class="cell">
<details class="code-fold">
<summary>Bus Ridership - (2021-2023)</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>bus_annual_data_2018_2023 <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">save_file =</span> <span class="cn">FALSE</span>, <span class="at">file_path =</span> <span class="st">"mta_ridership.xlsx"</span>) {</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># URL of the MTA Excel file</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  url <span class="ot">&lt;-</span> <span class="st">"https://www.mta.info/document/137111"</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a temporary file to store the download</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  temp_file <span class="ot">&lt;-</span> <span class="fu">tempfile</span>(<span class="at">fileext =</span> <span class="st">".xlsx"</span>)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  response <span class="ot">&lt;-</span> <span class="fu">GET</span>(url, <span class="fu">write_disk</span>(temp_file, <span class="at">overwrite =</span> <span class="cn">TRUE</span>))</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get all sheet names</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  sheet_names <span class="ot">&lt;-</span> <span class="fu">excel_sheets</span>(temp_file)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Find the sheet with "annual" and "total" in the name (case-insensitive)</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  annual_sheet <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"*total|total"</span>, sheet_names, </span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>                       <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(annual_sheet) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Could not find 'annual total' sheet. Available sheets: "</span>, </span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>         <span class="fu">paste</span>(sheet_names, <span class="at">collapse =</span> <span class="st">", "</span>))</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use the first match if multiple sheets found</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>  annual_sheet <span class="ot">&lt;-</span> annual_sheet[<span class="dv">1</span>]</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read the data from the annual total sheet</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(temp_file, <span class="at">sheet =</span> annual_sheet, <span class="at">skip=</span><span class="dv">1</span>)</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>  <span class="co">#clean data </span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="dv">2017</span>)) <span class="sc">|&gt;</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(Route, <span class="st">" "</span>)) <span class="sc">|&gt;</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span><span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">.</span><span class="sc">\\</span><span class="st">.</span><span class="sc">\\</span><span class="st">."</span>), <span class="sc">-</span><span class="fu">any_of</span>(<span class="st">"*"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^20</span><span class="sc">\\</span><span class="st">d{2}$"</span>), <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="fu">str_replace_all</span>(., <span class="st">","</span>, <span class="st">""</span>)))) <span class="sc">|&gt;</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">Route =</span> <span class="fu">if_else</span>(<span class="fu">str_starts</span>(Route, <span class="st">"X"</span>),</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">str_replace</span>(Route, <span class="st">"^X"</span>, <span class="st">"SIM"</span>),</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>                      Route)</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(Route) <span class="sc">|&gt;</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>      <span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^20</span><span class="sc">\\</span><span class="st">d{2}$"</span>), <span class="sc">~</span> <span class="fu">sum</span>(., <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>      <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Route =</span> <span class="fu">str_extract</span>(Route, <span class="st">"^[A-Za-z]+[0-9]+"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Route,<span class="st">"2021"</span>, <span class="st">"2022"</span>, <span class="st">"2023"</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Route <span class="sc">!=</span> <span class="st">"Adjustments"</span>) </span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clean up temp file</span></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unlink</span>(temp_file)</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data)</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>postcovid_bus_ridership <span class="ot">&lt;-</span> <span class="fu">bus_annual_data_2018_2023</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p><a href="https://github.com/miranda-adams/NYC-bus-stops-by-route/blob/master/bus_stops_gis.csv">Bus Stops by Routes</a></p>
<div class="cell">
<details class="code-fold">
<summary>Bus Stop - Coordinates</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>bus_stops_geompoints <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  url <span class="ot">&lt;-</span> <span class="st">"https://raw.githubusercontent.com/miranda-adams/NYC-bus-stops-by-route/master/bus_stops_gis.csv"</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Reading bus stops data from GitHub...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(url, <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>bus_stops <span class="ot">&lt;-</span> <span class="fu">bus_stops_geompoints</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p><a href="https://data.cityofnewyork.us/Transportation/Bus-Stop-Shelters/qafz-7myz">Bus Routes by Community Districts</a></p>
<div class="cell">
<details class="code-fold">
<summary>Bus Routes - CDs</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="st">"https://data.cityofnewyork.us/resource/qafz-7myz.csv"</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>bus_stop_shelters <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  url,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">show_col_types =</span> <span class="cn">FALSE</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p><a href="https://catalog.data.gov/dataset/mta-monthly-ridership-traffic-data-beginning-january-2008?">Staten Island Railroad Ridership Pre-COVID Ridership</a></p>
<div class="cell">
<details class="code-fold">
<summary>SIR Ridership - (2017-2019)</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>get_sir_ridership_precovid <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  url <span class="ot">&lt;-</span> <span class="st">"https://data.ny.gov/api/views/xfre-bxip/rows.csv?accessType=DOWNLOAD"</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  temp <span class="ot">&lt;-</span> <span class="fu">tempfile</span>(<span class="at">fileext =</span> <span class="st">".csv"</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">download.file</span>(url, temp, <span class="at">mode =</span> <span class="st">"wb"</span>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(temp, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">Month =</span> <span class="fu">as.Date</span>(Month),</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">year =</span> lubridate<span class="sc">::</span><span class="fu">year</span>(Month)</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>      year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2017</span>, <span class="dv">2018</span>, <span class="dv">2019</span>),</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>      Agency <span class="sc">==</span> <span class="st">"SIR"</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">total_ridership_2017 =</span> <span class="fu">sum</span>(Ridership[year <span class="sc">==</span> <span class="dv">2017</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">total_ridership_2018 =</span> <span class="fu">sum</span>(Ridership[year <span class="sc">==</span> <span class="dv">2018</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">total_ridership_2019 =</span> <span class="fu">sum</span>(Ridership[year <span class="sc">==</span> <span class="dv">2019</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_pre_covid =</span> <span class="fu">mean</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df)</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p><a href="https://data.ny.gov/Transportation/MTA-Daily-Ridership-Data-2020-2025/vxuj-8kew/about_data">Staten Island Ridership Post-COVID Ridership</a></p>
<div class="cell">
<details class="code-fold">
<summary>SIR Ridership - (2021-2023)</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>get_sir_ridership_postcovid <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">url =</span> <span class="st">"https://data.ny.gov/api/views/vxuj-8kew/rows.csv?accessType=DOWNLOAD"</span>,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">timeout_sec =</span> <span class="dv">300</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure required package</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"data.table"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(<span class="st">"data.table"</span>)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(data.table)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set extended timeout for download</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">options</span>(<span class="at">timeout =</span> timeout_sec)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Download to temp file</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  tmp_file <span class="ot">&lt;-</span> <span class="fu">tempfile</span>(<span class="at">fileext =</span> <span class="st">".csv"</span>)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">download.file</span>(url, tmp_file, <span class="at">mode =</span> <span class="st">"wb"</span>)</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read efficiently</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">fread</span>(tmp_file)</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">#CLEAN DATA</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Date =</span> <span class="fu">as.Date</span>(Date, <span class="at">format =</span> <span class="st">"%m/%d/%Y"</span>), <span class="at">year =</span> <span class="fu">year</span>(Date)) <span class="sc">|&gt;</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2021</span>, <span class="dv">2022</span>, <span class="dv">2023</span>)) <span class="sc">|&gt;</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">sir_total_estimated_ridership =</span> <span class="st">`</span><span class="at">Staten Island Railway: Total Estimated Ridership</span><span class="st">`</span>) <span class="sc">|&gt;</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">total_ridership_2021 =</span> <span class="fu">sum</span>(sir_total_estimated_ridership[year <span class="sc">==</span> <span class="dv">2021</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">total_ridership_2022 =</span> <span class="fu">sum</span>(sir_total_estimated_ridership[year <span class="sc">==</span> <span class="dv">2022</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">total_ridership_2023 =</span> <span class="fu">sum</span>(sir_total_estimated_ridership[year <span class="sc">==</span> <span class="dv">2023</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_post_covid =</span> <span class="fu">mean</span>(sir_total_estimated_ridership)</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df)</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>sir_precovid <span class="ot">&lt;-</span><span class="fu">get_sir_ridership_precovid</span>()</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>sir_postcovid <span class="ot">&lt;-</span> <span class="fu">get_sir_ridership_postcovid</span>()</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>sir_summary <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>  sir_precovid,</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>  sir_postcovid</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
</section>
<section id="merging-all-data-tables" class="level1">
<h1>MERGING ALL DATA TABLES</h1>
<p>With so many data tables to keep track of, a relation diagram was created to depict joining keys. For the end result, we expect there to be 59 rows, one for each community district. Key observations will be reported as columns, corresponding to each community district as rows.</p>
<p>Note: Due to the limitation involving SIR ridership data, which are not differentiated by community district, it was not included in the relation diagram. To account for the ridership, the estimations were simply summed to the corresponding total ridership year.</p>
<section id="relation-diagram" class="level3">
<h3 class="anchored" data-anchor-id="relation-diagram">Relation Diagram</h3>
<p><img src="Report_Relation_Diagram.png" class="img-fluid"></p>
<div class="cell">
<details class="code-fold">
<summary>Joining Ridership and Housing Prices by CDs</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>join_cd_transit_ridership <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  nyc_cd,</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  precovid_subway_ridership,</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  postcovid_subway_ridership,</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  stations,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  precovid_bus_ridership,</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  postcovid_bus_ridership,</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  bus_stops,</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  bus_stop_shelters,</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  sir_precovid,</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  sir_postcovid,</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>  cd_sales_panel </span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate area in square miles for each CD</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>  cd_areas <span class="ot">&lt;-</span> nyc_cd <span class="sc">|&gt;</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">area_sq_miles =</span> <span class="fu">as.numeric</span>(<span class="fu">st_area</span>(geometry)) <span class="sc">/</span> <span class="dv">27878400</span>) <span class="sc">|&gt;</span>  <span class="co"># Convert sq feet to sq miles</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_drop_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(cd_id, area_sq_miles)</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1. PROCESS SUBWAY RIDERSHIP BY COMMUNITY DISTRICT</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Join stations to community districts spatially</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>  stations_cd <span class="ot">&lt;-</span> <span class="fu">st_join</span>(stations, nyc_cd, <span class="at">left =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_drop_geometry</span>()</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Count subway stations per CD</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>  subway_station_counts <span class="ot">&lt;-</span> stations_cd <span class="sc">|&gt;</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(cd_id) <span class="sc">|&gt;</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">subway_stations =</span> <span class="fu">n_distinct</span>(<span class="st">`</span><span class="at">Stop Name</span><span class="st">`</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Pivot subway ridership data to long format and join</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>  subway_pre <span class="ot">&lt;-</span> precovid_subway_ridership <span class="sc">|&gt;</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(station_name, <span class="st">`</span><span class="at">2017</span><span class="st">`</span>, <span class="st">`</span><span class="at">2018</span><span class="st">`</span>, <span class="st">`</span><span class="at">2019</span><span class="st">`</span>) <span class="sc">|&gt;</span></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">2017</span><span class="st">`</span>, <span class="st">`</span><span class="at">2018</span><span class="st">`</span>, <span class="st">`</span><span class="at">2019</span><span class="st">`</span>), </span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>                 <span class="at">names_to =</span> <span class="st">"year"</span>, </span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>                 <span class="at">values_to =</span> <span class="st">"ridership"</span>) <span class="sc">|&gt;</span></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">ridership =</span> <span class="fu">as.numeric</span>(ridership))</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>  subway_post <span class="ot">&lt;-</span> postcovid_subway_ridership <span class="sc">|&gt;</span></span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(station_name, <span class="st">`</span><span class="at">2021</span><span class="st">`</span>, <span class="st">`</span><span class="at">2022</span><span class="st">`</span>, <span class="st">`</span><span class="at">2023</span><span class="st">`</span>) <span class="sc">|&gt;</span></span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">2021</span><span class="st">`</span>, <span class="st">`</span><span class="at">2022</span><span class="st">`</span>, <span class="st">`</span><span class="at">2023</span><span class="st">`</span>), </span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>                 <span class="at">names_to =</span> <span class="st">"year"</span>, </span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>                 <span class="at">values_to =</span> <span class="st">"ridership"</span>) <span class="sc">|&gt;</span></span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">ridership =</span> <span class="fu">as.numeric</span>(ridership))</span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Aggregate subway ridership by CD</span></span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>  subway_by_cd_pre <span class="ot">&lt;-</span> stations_cd <span class="sc">|&gt;</span></span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(subway_pre, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Stop Name"</span> <span class="ot">=</span> <span class="st">"station_name"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(cd_id, year) <span class="sc">|&gt;</span></span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">subway_ridership =</span> <span class="fu">sum</span>(ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> year, </span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>                <span class="at">values_from =</span> subway_ridership,</span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>                <span class="at">names_prefix =</span> <span class="st">"subway_"</span>)</span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>  subway_by_cd_post <span class="ot">&lt;-</span> stations_cd <span class="sc">|&gt;</span></span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(subway_post, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Stop Name"</span> <span class="ot">=</span> <span class="st">"station_name"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(cd_id, year) <span class="sc">|&gt;</span></span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">subway_ridership =</span> <span class="fu">sum</span>(ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> year, </span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>                <span class="at">values_from =</span> subway_ridership,</span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>                <span class="at">names_prefix =</span> <span class="st">"subway_"</span>)</span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2. PROCESS BUS RIDERSHIP BY COMMUNITY DISTRICT</span></span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create bus stops sf object</span></span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a>  bus_stops_sf <span class="ot">&lt;-</span> bus_stops <span class="sc">|&gt;</span></span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(stop_lat) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(stop_lon)) <span class="sc">|&gt;</span></span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"stop_lon"</span>, <span class="st">"stop_lat"</span>), <span class="at">crs =</span> <span class="dv">4326</span>) <span class="sc">|&gt;</span></span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="dv">2263</span>)</span>
<span id="cb15-69"><a href="#cb15-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-70"><a href="#cb15-70" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Join bus stops to community districts</span></span>
<span id="cb15-71"><a href="#cb15-71" aria-hidden="true" tabindex="-1"></a>  bus_stops_cd <span class="ot">&lt;-</span> <span class="fu">st_join</span>(bus_stops_sf, nyc_cd, <span class="at">left =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb15-72"><a href="#cb15-72" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_drop_geometry</span>()</span>
<span id="cb15-73"><a href="#cb15-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-74"><a href="#cb15-74" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Count bus stops per CD</span></span>
<span id="cb15-75"><a href="#cb15-75" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use n() since each row is a unique bus stop location</span></span>
<span id="cb15-76"><a href="#cb15-76" aria-hidden="true" tabindex="-1"></a>  bus_stop_counts <span class="ot">&lt;-</span> bus_stops_cd <span class="sc">|&gt;</span></span>
<span id="cb15-77"><a href="#cb15-77" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(cd_id) <span class="sc">|&gt;</span></span>
<span id="cb15-78"><a href="#cb15-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">bus_stops =</span> <span class="fu">n</span>(), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb15-79"><a href="#cb15-79" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-80"><a href="#cb15-80" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Process bus ridership data</span></span>
<span id="cb15-81"><a href="#cb15-81" aria-hidden="true" tabindex="-1"></a>  bus_pre <span class="ot">&lt;-</span> precovid_bus_ridership <span class="sc">|&gt;</span></span>
<span id="cb15-82"><a href="#cb15-82" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">2017</span><span class="st">`</span>, <span class="st">`</span><span class="at">2018</span><span class="st">`</span>, <span class="st">`</span><span class="at">2019</span><span class="st">`</span>), </span>
<span id="cb15-83"><a href="#cb15-83" aria-hidden="true" tabindex="-1"></a>                 <span class="at">names_to =</span> <span class="st">"year"</span>, </span>
<span id="cb15-84"><a href="#cb15-84" aria-hidden="true" tabindex="-1"></a>                 <span class="at">values_to =</span> <span class="st">"ridership"</span>)</span>
<span id="cb15-85"><a href="#cb15-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-86"><a href="#cb15-86" aria-hidden="true" tabindex="-1"></a>  bus_post <span class="ot">&lt;-</span> postcovid_bus_ridership <span class="sc">|&gt;</span></span>
<span id="cb15-87"><a href="#cb15-87" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">2021</span><span class="st">`</span>, <span class="st">`</span><span class="at">2022</span><span class="st">`</span>, <span class="st">`</span><span class="at">2023</span><span class="st">`</span>), </span>
<span id="cb15-88"><a href="#cb15-88" aria-hidden="true" tabindex="-1"></a>                 <span class="at">names_to =</span> <span class="st">"year"</span>, </span>
<span id="cb15-89"><a href="#cb15-89" aria-hidden="true" tabindex="-1"></a>                 <span class="at">values_to =</span> <span class="st">"ridership"</span>)</span>
<span id="cb15-90"><a href="#cb15-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-91"><a href="#cb15-91" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Aggregate bus ridership by CD (using route assignments)</span></span>
<span id="cb15-92"><a href="#cb15-92" aria-hidden="true" tabindex="-1"></a>  bus_by_cd_pre <span class="ot">&lt;-</span> bus_stops_cd <span class="sc">|&gt;</span></span>
<span id="cb15-93"><a href="#cb15-93" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(bus_pre, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"route_id"</span> <span class="ot">=</span> <span class="st">"Route"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb15-94"><a href="#cb15-94" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(cd_id, year) <span class="sc">|&gt;</span></span>
<span id="cb15-95"><a href="#cb15-95" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">bus_ridership =</span> <span class="fu">sum</span>(ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">n_distinct</span>(route_id), </span>
<span id="cb15-96"><a href="#cb15-96" aria-hidden="true" tabindex="-1"></a>              <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb15-97"><a href="#cb15-97" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> year, </span>
<span id="cb15-98"><a href="#cb15-98" aria-hidden="true" tabindex="-1"></a>                <span class="at">values_from =</span> bus_ridership,</span>
<span id="cb15-99"><a href="#cb15-99" aria-hidden="true" tabindex="-1"></a>                <span class="at">names_prefix =</span> <span class="st">"bus_"</span>)</span>
<span id="cb15-100"><a href="#cb15-100" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-101"><a href="#cb15-101" aria-hidden="true" tabindex="-1"></a>  bus_by_cd_post <span class="ot">&lt;-</span> bus_stops_cd <span class="sc">|&gt;</span></span>
<span id="cb15-102"><a href="#cb15-102" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(bus_post, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"route_id"</span> <span class="ot">=</span> <span class="st">"Route"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb15-103"><a href="#cb15-103" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(cd_id, year) <span class="sc">|&gt;</span></span>
<span id="cb15-104"><a href="#cb15-104" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">bus_ridership =</span> <span class="fu">sum</span>(ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">n_distinct</span>(route_id), </span>
<span id="cb15-105"><a href="#cb15-105" aria-hidden="true" tabindex="-1"></a>              <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb15-106"><a href="#cb15-106" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> year, </span>
<span id="cb15-107"><a href="#cb15-107" aria-hidden="true" tabindex="-1"></a>                <span class="at">values_from =</span> bus_ridership,</span>
<span id="cb15-108"><a href="#cb15-108" aria-hidden="true" tabindex="-1"></a>                <span class="at">names_prefix =</span> <span class="st">"bus_"</span>)</span>
<span id="cb15-109"><a href="#cb15-109" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-110"><a href="#cb15-110" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 3. COMBINE ALL TRANSIT MODES BY COMMUNITY DISTRICT</span></span>
<span id="cb15-111"><a href="#cb15-111" aria-hidden="true" tabindex="-1"></a>  cd_transit <span class="ot">&lt;-</span> nyc_cd <span class="sc">|&gt;</span></span>
<span id="cb15-112"><a href="#cb15-112" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_drop_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb15-113"><a href="#cb15-113" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(cd_id, boro_abbr) <span class="sc">|&gt;</span></span>
<span id="cb15-114"><a href="#cb15-114" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(cd_areas, <span class="at">by =</span> <span class="st">"cd_id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb15-115"><a href="#cb15-115" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(subway_station_counts, <span class="at">by =</span> <span class="st">"cd_id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb15-116"><a href="#cb15-116" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(bus_stop_counts, <span class="at">by =</span> <span class="st">"cd_id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb15-117"><a href="#cb15-117" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(subway_by_cd_pre, <span class="at">by =</span> <span class="st">"cd_id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb15-118"><a href="#cb15-118" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(subway_by_cd_post, <span class="at">by =</span> <span class="st">"cd_id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb15-119"><a href="#cb15-119" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(bus_by_cd_pre, <span class="at">by =</span> <span class="st">"cd_id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb15-120"><a href="#cb15-120" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(bus_by_cd_post, <span class="at">by =</span> <span class="st">"cd_id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb15-121"><a href="#cb15-121" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="fu">c</span>(<span class="st">"subway_"</span>, <span class="st">"bus_"</span>)), <span class="sc">~</span><span class="fu">replace_na</span>(., <span class="dv">0</span>)),</span>
<span id="cb15-122"><a href="#cb15-122" aria-hidden="true" tabindex="-1"></a>           <span class="at">subway_stations =</span> <span class="fu">replace_na</span>(subway_stations, <span class="dv">0</span>),</span>
<span id="cb15-123"><a href="#cb15-123" aria-hidden="true" tabindex="-1"></a>           <span class="at">bus_stops =</span> <span class="fu">replace_na</span>(bus_stops, <span class="dv">0</span>))</span>
<span id="cb15-124"><a href="#cb15-124" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-125"><a href="#cb15-125" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 4. ADD STATEN ISLAND RAILROAD (only for Staten Island CDs)</span></span>
<span id="cb15-126"><a href="#cb15-126" aria-hidden="true" tabindex="-1"></a>  sir_total_pre <span class="ot">&lt;-</span> sir_precovid <span class="sc">|&gt;</span></span>
<span id="cb15-127"><a href="#cb15-127" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(total_ridership_2017, total_ridership_2018, total_ridership_2019)</span>
<span id="cb15-128"><a href="#cb15-128" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-129"><a href="#cb15-129" aria-hidden="true" tabindex="-1"></a>  sir_total_post <span class="ot">&lt;-</span> sir_postcovid <span class="sc">|&gt;</span></span>
<span id="cb15-130"><a href="#cb15-130" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(total_ridership_2021, total_ridership_2022, total_ridership_2023)</span>
<span id="cb15-131"><a href="#cb15-131" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-132"><a href="#cb15-132" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Count Staten Island CDs</span></span>
<span id="cb15-133"><a href="#cb15-133" aria-hidden="true" tabindex="-1"></a>  si_cd_count <span class="ot">&lt;-</span> <span class="fu">sum</span>(cd_transit<span class="sc">$</span>boro_abbr <span class="sc">==</span> <span class="st">"SI"</span>)</span>
<span id="cb15-134"><a href="#cb15-134" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-135"><a href="#cb15-135" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Distribute SIR ridership equally across Staten Island CDs</span></span>
<span id="cb15-136"><a href="#cb15-136" aria-hidden="true" tabindex="-1"></a>  cd_transit <span class="ot">&lt;-</span> cd_transit <span class="sc">|&gt;</span></span>
<span id="cb15-137"><a href="#cb15-137" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb15-138"><a href="#cb15-138" aria-hidden="true" tabindex="-1"></a>      <span class="at">sir_2017 =</span> <span class="fu">if_else</span>(boro_abbr <span class="sc">==</span> <span class="st">"SI"</span>, sir_total_pre<span class="sc">$</span>total_ridership_2017, <span class="dv">0</span>),</span>
<span id="cb15-139"><a href="#cb15-139" aria-hidden="true" tabindex="-1"></a>      <span class="at">sir_2018 =</span> <span class="fu">if_else</span>(boro_abbr <span class="sc">==</span> <span class="st">"SI"</span>, sir_total_pre<span class="sc">$</span>total_ridership_2018, <span class="dv">0</span>),</span>
<span id="cb15-140"><a href="#cb15-140" aria-hidden="true" tabindex="-1"></a>      <span class="at">sir_2019 =</span> <span class="fu">if_else</span>(boro_abbr <span class="sc">==</span> <span class="st">"SI"</span>, sir_total_pre<span class="sc">$</span>total_ridership_2019, <span class="dv">0</span>),</span>
<span id="cb15-141"><a href="#cb15-141" aria-hidden="true" tabindex="-1"></a>      <span class="at">sir_2021 =</span> <span class="fu">if_else</span>(boro_abbr <span class="sc">==</span> <span class="st">"SI"</span>, sir_total_post<span class="sc">$</span>total_ridership_2021 <span class="sc">/</span> si_cd_count, <span class="dv">0</span>),</span>
<span id="cb15-142"><a href="#cb15-142" aria-hidden="true" tabindex="-1"></a>      <span class="at">sir_2022 =</span> <span class="fu">if_else</span>(boro_abbr <span class="sc">==</span> <span class="st">"SI"</span>, sir_total_post<span class="sc">$</span>total_ridership_2022 <span class="sc">/</span> si_cd_count, <span class="dv">0</span>),</span>
<span id="cb15-143"><a href="#cb15-143" aria-hidden="true" tabindex="-1"></a>      <span class="at">sir_2023 =</span> <span class="fu">if_else</span>(boro_abbr <span class="sc">==</span> <span class="st">"SI"</span>, sir_total_post<span class="sc">$</span>total_ridership_2023 <span class="sc">/</span> si_cd_count, <span class="dv">0</span>)</span>
<span id="cb15-144"><a href="#cb15-144" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-145"><a href="#cb15-145" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-146"><a href="#cb15-146" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 5. JOINING SALES DATA</span></span>
<span id="cb15-147"><a href="#cb15-147" aria-hidden="true" tabindex="-1"></a>  cd_transit <span class="ot">&lt;-</span> cd_transit <span class="sc">|&gt;</span></span>
<span id="cb15-148"><a href="#cb15-148" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(</span>
<span id="cb15-149"><a href="#cb15-149" aria-hidden="true" tabindex="-1"></a>      cd_sales_panel <span class="sc">|&gt;</span> <span class="fu">select</span>(cd_id, <span class="fu">starts_with</span>(<span class="st">"median_sale_price"</span>), <span class="fu">starts_with</span>(<span class="st">"sales"</span>)),</span>
<span id="cb15-150"><a href="#cb15-150" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="st">"cd_id"</span></span>
<span id="cb15-151"><a href="#cb15-151" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-152"><a href="#cb15-152" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-153"><a href="#cb15-153" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-154"><a href="#cb15-154" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 6. CALCULATE TOTAL RIDERSHIP, MEANS, AND ACCESSIBILITY METRICS</span></span>
<span id="cb15-155"><a href="#cb15-155" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> cd_transit <span class="sc">|&gt;</span></span>
<span id="cb15-156"><a href="#cb15-156" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb15-157"><a href="#cb15-157" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Total ridership per year (combining all transit modes)</span></span>
<span id="cb15-158"><a href="#cb15-158" aria-hidden="true" tabindex="-1"></a>      <span class="at">total_ridership_2017 =</span> subway_2017 <span class="sc">+</span> bus_2017 <span class="sc">+</span> sir_2017,</span>
<span id="cb15-159"><a href="#cb15-159" aria-hidden="true" tabindex="-1"></a>      <span class="at">total_ridership_2018 =</span> subway_2018 <span class="sc">+</span> bus_2018 <span class="sc">+</span> sir_2018,</span>
<span id="cb15-160"><a href="#cb15-160" aria-hidden="true" tabindex="-1"></a>      <span class="at">total_ridership_2019 =</span> subway_2019 <span class="sc">+</span> bus_2019 <span class="sc">+</span> sir_2019,</span>
<span id="cb15-161"><a href="#cb15-161" aria-hidden="true" tabindex="-1"></a>      <span class="at">total_ridership_2021 =</span> subway_2021 <span class="sc">+</span> bus_2021 <span class="sc">+</span> sir_2021,</span>
<span id="cb15-162"><a href="#cb15-162" aria-hidden="true" tabindex="-1"></a>      <span class="at">total_ridership_2022 =</span> subway_2022 <span class="sc">+</span> bus_2022 <span class="sc">+</span> sir_2022,</span>
<span id="cb15-163"><a href="#cb15-163" aria-hidden="true" tabindex="-1"></a>      <span class="at">total_ridership_2023 =</span> subway_2023 <span class="sc">+</span> bus_2023 <span class="sc">+</span> sir_2023,</span>
<span id="cb15-164"><a href="#cb15-164" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb15-165"><a href="#cb15-165" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Mean ridership by period</span></span>
<span id="cb15-166"><a href="#cb15-166" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_precovid =</span> (total_ridership_2017 <span class="sc">+</span> total_ridership_2018 <span class="sc">+</span> total_ridership_2019) <span class="sc">/</span> <span class="dv">3</span>,</span>
<span id="cb15-167"><a href="#cb15-167" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_postcovid =</span> (total_ridership_2021 <span class="sc">+</span> total_ridership_2022 <span class="sc">+</span> total_ridership_2023) <span class="sc">/</span> <span class="dv">3</span>,</span>
<span id="cb15-168"><a href="#cb15-168" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb15-169"><a href="#cb15-169" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Alternative naming (for compatibility)</span></span>
<span id="cb15-170"><a href="#cb15-170" aria-hidden="true" tabindex="-1"></a>      <span class="at">avg_ridership_pre =</span> mean_precovid,</span>
<span id="cb15-171"><a href="#cb15-171" aria-hidden="true" tabindex="-1"></a>      <span class="at">avg_ridership_post =</span> mean_postcovid,</span>
<span id="cb15-172"><a href="#cb15-172" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb15-173"><a href="#cb15-173" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Percent change in ridership (pre-COVID to post-COVID)</span></span>
<span id="cb15-174"><a href="#cb15-174" aria-hidden="true" tabindex="-1"></a>      <span class="at">combined_percent_change =</span> <span class="fu">if_else</span>(</span>
<span id="cb15-175"><a href="#cb15-175" aria-hidden="true" tabindex="-1"></a>        mean_precovid <span class="sc">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb15-176"><a href="#cb15-176" aria-hidden="true" tabindex="-1"></a>        (mean_postcovid <span class="sc">-</span> mean_precovid) <span class="sc">/</span> mean_precovid <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb15-177"><a href="#cb15-177" aria-hidden="true" tabindex="-1"></a>        <span class="cn">NA_real_</span></span>
<span id="cb15-178"><a href="#cb15-178" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb15-179"><a href="#cb15-179" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb15-180"><a href="#cb15-180" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Transit stop density (stops per square mile)</span></span>
<span id="cb15-181"><a href="#cb15-181" aria-hidden="true" tabindex="-1"></a>      <span class="at">total_transit_stops =</span> subway_stations <span class="sc">+</span> bus_stops,</span>
<span id="cb15-182"><a href="#cb15-182" aria-hidden="true" tabindex="-1"></a>      <span class="at">transit_stop_density =</span> total_transit_stops <span class="sc">/</span> area_sq_miles,</span>
<span id="cb15-183"><a href="#cb15-183" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb15-184"><a href="#cb15-184" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Ridership density (annual ridership per square mile)</span></span>
<span id="cb15-185"><a href="#cb15-185" aria-hidden="true" tabindex="-1"></a>      <span class="at">ridership_density_precovid =</span> mean_precovid <span class="sc">/</span> area_sq_miles,</span>
<span id="cb15-186"><a href="#cb15-186" aria-hidden="true" tabindex="-1"></a>      <span class="at">ridership_density_postcovid =</span> mean_postcovid <span class="sc">/</span> area_sq_miles,</span>
<span id="cb15-187"><a href="#cb15-187" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb15-188"><a href="#cb15-188" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Accessibility index: combines stop density and ridership density</span></span>
<span id="cb15-189"><a href="#cb15-189" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Normalized to 0-100 scale (will calculate percentile ranks)</span></span>
<span id="cb15-190"><a href="#cb15-190" aria-hidden="true" tabindex="-1"></a>      <span class="at">accessibility_score_precovid =</span> (transit_stop_density <span class="sc">/</span> <span class="fu">max</span>(transit_stop_density, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="dv">50</span>) <span class="sc">+</span></span>
<span id="cb15-191"><a href="#cb15-191" aria-hidden="true" tabindex="-1"></a>                                     (ridership_density_precovid <span class="sc">/</span> <span class="fu">max</span>(ridership_density_precovid, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="dv">50</span>),</span>
<span id="cb15-192"><a href="#cb15-192" aria-hidden="true" tabindex="-1"></a>      <span class="at">accessibility_score_postcovid =</span> (transit_stop_density <span class="sc">/</span> <span class="fu">max</span>(transit_stop_density, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="dv">50</span>) <span class="sc">+</span></span>
<span id="cb15-193"><a href="#cb15-193" aria-hidden="true" tabindex="-1"></a>                                      (ridership_density_postcovid <span class="sc">/</span> <span class="fu">max</span>(ridership_density_postcovid, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="dv">50</span>)</span>
<span id="cb15-194"><a href="#cb15-194" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-195"><a href="#cb15-195" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-196"><a href="#cb15-196" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Base columns to select</span></span>
<span id="cb15-197"><a href="#cb15-197" aria-hidden="true" tabindex="-1"></a>  base_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb15-198"><a href="#cb15-198" aria-hidden="true" tabindex="-1"></a>    <span class="st">"community_district"</span> <span class="ot">=</span> <span class="st">"cd_id"</span>,</span>
<span id="cb15-199"><a href="#cb15-199" aria-hidden="true" tabindex="-1"></a>    <span class="st">"area_sq_miles"</span>,</span>
<span id="cb15-200"><a href="#cb15-200" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_transit_stops"</span>,</span>
<span id="cb15-201"><a href="#cb15-201" aria-hidden="true" tabindex="-1"></a>    <span class="st">"transit_stop_density"</span>,</span>
<span id="cb15-202"><a href="#cb15-202" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_ridership_2017"</span>,</span>
<span id="cb15-203"><a href="#cb15-203" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_ridership_2018"</span>,</span>
<span id="cb15-204"><a href="#cb15-204" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_ridership_2019"</span>,</span>
<span id="cb15-205"><a href="#cb15-205" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mean_precovid"</span>,</span>
<span id="cb15-206"><a href="#cb15-206" aria-hidden="true" tabindex="-1"></a>    <span class="st">"avg_ridership_pre"</span>,</span>
<span id="cb15-207"><a href="#cb15-207" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ridership_density_precovid"</span>,</span>
<span id="cb15-208"><a href="#cb15-208" aria-hidden="true" tabindex="-1"></a>    <span class="st">"accessibility_score_precovid"</span>,</span>
<span id="cb15-209"><a href="#cb15-209" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_ridership_2021"</span>,</span>
<span id="cb15-210"><a href="#cb15-210" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_ridership_2022"</span>,</span>
<span id="cb15-211"><a href="#cb15-211" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_ridership_2023"</span>,</span>
<span id="cb15-212"><a href="#cb15-212" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mean_postcovid"</span>,</span>
<span id="cb15-213"><a href="#cb15-213" aria-hidden="true" tabindex="-1"></a>    <span class="st">"avg_ridership_post"</span>,</span>
<span id="cb15-214"><a href="#cb15-214" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ridership_density_postcovid"</span>,</span>
<span id="cb15-215"><a href="#cb15-215" aria-hidden="true" tabindex="-1"></a>    <span class="st">"accessibility_score_postcovid"</span>,</span>
<span id="cb15-216"><a href="#cb15-216" aria-hidden="true" tabindex="-1"></a>    <span class="st">"combined_percent_change"</span></span>
<span id="cb15-217"><a href="#cb15-217" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb15-218"><a href="#cb15-218" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-219"><a href="#cb15-219" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add sales columns if they exist</span></span>
<span id="cb15-220"><a href="#cb15-220" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"median_sale_price_precovid"</span> <span class="sc">%in%</span> <span class="fu">names</span>(result)) {</span>
<span id="cb15-221"><a href="#cb15-221" aria-hidden="true" tabindex="-1"></a>    result <span class="ot">&lt;-</span> result <span class="sc">|&gt;</span></span>
<span id="cb15-222"><a href="#cb15-222" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">!!!</span>base_cols,</span>
<span id="cb15-223"><a href="#cb15-223" aria-hidden="true" tabindex="-1"></a>             median_sale_price_precovid,</span>
<span id="cb15-224"><a href="#cb15-224" aria-hidden="true" tabindex="-1"></a>             sales_pre_covid,</span>
<span id="cb15-225"><a href="#cb15-225" aria-hidden="true" tabindex="-1"></a>             median_sale_price_postcovid,</span>
<span id="cb15-226"><a href="#cb15-226" aria-hidden="true" tabindex="-1"></a>             sales_post_covid)</span>
<span id="cb15-227"><a href="#cb15-227" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb15-228"><a href="#cb15-228" aria-hidden="true" tabindex="-1"></a>    result <span class="ot">&lt;-</span> result <span class="sc">|&gt;</span></span>
<span id="cb15-229"><a href="#cb15-229" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">!!!</span>base_cols)</span>
<span id="cb15-230"><a href="#cb15-230" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-231"><a href="#cb15-231" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-232"><a href="#cb15-232" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb15-233"><a href="#cb15-233" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-234"><a href="#cb15-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-235"><a href="#cb15-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-236"><a href="#cb15-236" aria-hidden="true" tabindex="-1"></a>format_titles <span class="ot">&lt;-</span> <span class="cf">function</span>(df){</span>
<span id="cb15-237"><a href="#cb15-237" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(df) <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(<span class="fu">colnames</span>(df), <span class="st">"_"</span>, <span class="st">" "</span>) <span class="sc">|&gt;</span> <span class="fu">str_to_title</span>()</span>
<span id="cb15-238"><a href="#cb15-238" aria-hidden="true" tabindex="-1"></a>    df</span>
<span id="cb15-239"><a href="#cb15-239" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="mta-ridership-and-housing-prices-by-community-districts" class="level3">
<h3 class="anchored" data-anchor-id="mta-ridership-and-housing-prices-by-community-districts">MTA Ridership and Housing Prices by Community Districts</h3>
<div class="cell">
<details class="code-fold">
<summary>Display Data Table</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>cd_ridership_sales_price <span class="ot">&lt;-</span> <span class="fu">join_cd_transit_ridership</span>(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  nyc_cd,</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  precovid_subway_ridership,</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  postcovid_subway_ridership,</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  stations,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  precovid_bus_ridership,</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  postcovid_bus_ridership,</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  bus_stops,</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  bus_stop_shelters,</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  sir_precovid,</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  sir_postcovid,</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">cd_sales_panel =</span> cd_sales  <span class="co"># Optional: include housing data</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">format_titles</span>() </span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>cd_ridership_sales_price <span class="sc">|&gt;</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(<span class="at">options =</span> <span class="fu">list</span>(<span class="at">searching =</span> <span class="cn">FALSE</span>, <span class="at">info =</span> <span class="cn">FALSE</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-9f093cf29efff282f749" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-9f093cf29efff282f749">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59"],["QN10","MN04","MN07","BK17","QN13","BK13","BX02","BX05","QN03","QN04","MN05","QN11","MN06","MN10","BK03","BX03","SI01","MN09","BK12","BK14","BX04","BX06","BX07","BK10","MN02","QN01","QN02","MN08","BX09","BK07","MN12","BX08","BK06","BK11","BK15","QN06","BX12","BK08","BK09","MN11","BX01","BK16","QN07","QN14","BX10","BX11","BK18","SI02","SI03","BK01","QN08","QN12","BK05","QN09","BK02","BK04","QN05","MN01","MN03"],[6.172436411542197,1.768751891893773,1.906587158590589,3.365273885926042,12.57143464841767,3.166064262465066,2.217099121689053,1.374432661183904,2.994272273378661,2.358084021666015,1.570752697825151,9.339175011016094,1.389249134264272,1.401577535163651,2.850296733776115,1.606880120906663,13.53133921701794,1.502776010669679,3.569963991486873,2.947619558719621,1.99158422044573,1.530371904702025,1.912161602598351,3.993910614727452,1.353162910762782,6.149686001704967,5.022171154482115,1.98056368711773,4.099378018061874,3.735020362795916,2.796567005478915,3.302778242273639,3.066951965291666,3.702098597415247,4.722255286282968,2.96656646334517,5.55649639045968,1.635981085233636,1.625475025254319,2.373194439186244,2.166544822474552,1.857017238302115,11.77555559672037,7.015338798710647,6.419327669377183,3.598290441498857,8.453547089387415,21.217614068275,21.53444376123378,4.723924011723764,7.445057870405281,9.589293464474293,5.577342611968728,3.851677414888683,2.845216486145949,2.032502922355236,7.546877564436521,1.495555918372033,1.681530573650547],[304,147,223,226,520,178,106,129,264,204,201,337,136,190,303,143,735,197,222,200,159,130,177,275,121,325,297,200,215,175,247,135,165,199,292,160,230,162,133,171,146,179,624,192,354,185,492,497,414,334,334,697,363,284,269,172,485,98,185],[49.25121616992809,83.10945174035096,116.9629193164444,67.15649532870347,41.36361636859409,56.22122144211028,47.8102214569667,93.85690812155357,88.16833470595148,86.51091230238332,127.9641284578423,36.08455774760502,97.89460842242943,135.5615335100353,106.3047213328491,88.99232627217638,54.31834855456241,131.0907271618019,62.18550117855336,67.85136141750785,79.83594083930565,84.94667185184112,92.56539811252493,68.8548208830573,89.42012749358609,52.84822670781818,59.13776947544643,100.9813525820296,52.44698074993554,46.8538275569134,88.32257532756702,40.87467886038444,53.79934275700617,53.75329553322513,61.83486116224822,53.93440597976027,41.39299008542548,99.0231497553437,81.82223530576302,72.05477864621788,67.38840502420064,96.39113536913692,52.991130216717,27.36859979382433,55.14596204345896,51.41330390298867,58.20042105374404,23.42393439718202,19.22501479909507,70.70393155585987,44.86197499252189,72.6852298954239,65.0847590429568,73.73410839189081,94.54465110469677,84.6247245739203,64.26498851465229,65.52747295913655,110.0188143462483],[52994807,228083807.125,133040615.8181818,142575798.75,91681721.07142857,89537828.125,8934449,21354060,69356572.5,141733807,874521852.9333333,100143873.5454545,112390301.1,135793919.5,130136965.125,3891266,38513525.86363637,182792911.75,154467312.6666667,134041763,41507876,0,32053192,80240666.45454545,233788062.4444444,50296458,100166056,147047344.6923077,9305184,84004754.90000001,137656472.4285714,6598222,91144419.375,200689691.2857143,133108075.4545455,40679314.6,13961917,40329751.28571428,80798050.7,136439421.6666667,27860458,57643910.07142857,110199781.3846154,4307631,6783261,14585930,167767951.0666667,23424165.3,21203982.66666667,122421757.3076923,84110466.22222222,79109290.27777778,123700906.5,98533988.2,182271100.4,81115932.78571428,112518142.6363636,330168313.1666667,78813592.8],[49101605,223493424.75,131255864.0909091,132777522.0833333,88198731.64285715,85220283.625,8378596,19504950,71080948.5,137936957.6,857609314,96082092,114124833.9,131500417.75,122430491.9375,3411145,35543801.72727273,173986376.75,147280570.3333333,125803506.5833333,38383939,0,29984408,79319269.45454545,232664927.4444444,48569657,102202157.5,145295469.6153846,8825282,80459986.90000001,133268914.7142857,6427337,89007415,190080186.4285714,128164513.3636364,38570004,13248852,37484818.5,75357161.59999999,134115295,26513392,53871688.14285714,105955381.6153846,3994707,6644915,13713115,155018549.8,21511118.85,19406753.66666667,114791551.0769231,81180726.8888889,75461468.94444445,114282588.5,92728346.2,179848036.5333333,77511613.57142857,108231495.6363636,334924460.6666667,78188843.09999999],[46100835.27940001,230664740.1651,132618113.8350545,127123353.5982503,87220348.48987171,84731347.84462526,8278317,19482429,69375236.60659994,137357372.4034801,873004144.3838401,94528341.84320897,115878107.3145099,128407237.4170248,119714956.0342374,3415939,39445680.39428192,174850877.4768125,144344367.7805113,121977004.3953835,38072572,0,29697469,80525129.0456728,234280613.0565667,49865978.0905,101129462.981375,149051106.2198,8701386,79995749.22848994,132397153.5742572,6312509,89121101.415075,189810785.4714574,129633609.2072544,37972147.20459999,12971882,37099460.44302139,73568309.01266006,134007378.7930249,26552868,51692666.97700004,105268306.1148382,3916603,6628541,13710135,151311879.5165464,25370812.49309503,23534067.59271324,114384914.5308924,80944692.55158876,74313479.53252234,110113532.7005246,87843637.99095991,179022242.1951801,73826448.45800717,106571150.2106731,336567918.1056666,79714891.39001998],[49399082.42646667,227413990.6800333,132304864.5813818,134158891.4771945,89033600.40138581,86496486.53154175,8530454,20113813,69937585.86886664,139009379.0011601,868378437.1057245,96918102.46288784,114131080.7715033,131900524.8890083,124094137.6989125,3572783.333333333,37834335.99506367,177210055.3256042,148697416.9268371,127274091.3262389,39321462.33333334,0,30578356.33333333,80028354.98492123,233577867.6484852,49577364.3635,101165892.1604583,147131306.8424974,8943950.666666666,81486830.34282999,134440846.9057048,6446022.666666667,89757645.26335834,193526887.728581,130302066.0084788,39073821.93486666,13394217,38304676.74291189,76574507.10422002,134854031.8198972,26975572.66666667,54402755.06376192,107141156.3716127,4072980.333333333,6685572.333333333,14003060,158032793.461071,23435365.54769835,21381601.30868219,117199407.6385026,82078628.5542333,76294746.2515815,116032342.5668415,93035324.13031997,180380459.7095045,77484664.93838334,109106929.4944668,333886897.313,78905775.76333998],[49399082.42646667,227413990.6800333,132304864.5813818,134158891.4771945,89033600.40138581,86496486.53154175,8530454,20113813,69937585.86886664,139009379.0011601,868378437.1057245,96918102.46288784,114131080.7715033,131900524.8890083,124094137.6989125,3572783.333333333,37834335.99506367,177210055.3256042,148697416.9268371,127274091.3262389,39321462.33333334,0,30578356.33333333,80028354.98492123,233577867.6484852,49577364.3635,101165892.1604583,147131306.8424974,8943950.666666666,81486830.34282999,134440846.9057048,6446022.666666667,89757645.26335834,193526887.728581,130302066.0084788,39073821.93486666,13394217,38304676.74291189,76574507.10422002,134854031.8198972,26975572.66666667,54402755.06376192,107141156.3716127,4072980.333333333,6685572.333333333,14003060,158032793.461071,23435365.54769835,21381601.30868219,117199407.6385026,82078628.5542333,76294746.2515815,116032342.5668415,93035324.13031997,180380459.7095045,77484664.93838334,109106929.4944668,333886897.313,78905775.76333998],[8003173.970993441,128573143.4251895,69393556.9560774,39865668.00350553,7082214.790226208,27319877.09693437,3847574.479891202,14634265.88151248,23357123.02807749,58950138.21557903,552842238.1881456,10377587.13682604,82153069.56584543,94108618.02490814,43537269.72647888,2223428.672026531,2796052.584911966,117921802.0965309,41652357.63762014,43178601.84830769,19743810.94691186,0,15991512.58543304,20037592.90200901,172616220.7008886,8061771.666025704,20143855.92378134,74287591.86058508,2181782.364851348,21816970.84024237,48073529.66773691,1951697.084642659,29266074.68233446,52274914.521104,27593185.48215201,13171396.09634975,2410550.832534946,23413887.29286046,47109002.54664896,56823844.51656558,12450964.49740472,29295772.78103394,9098607.32188745,580582.1287037354,1041475.474951411,3891586.915415051,18694258.37344248,1104524.074775182,992902.41929412,24809757.17383236,11024578.98688775,7956242.713212673,20804234.31722508,24154495.32992855,63397797.87858703,38122781.56461157,14457227.98109461,223252700.3580368,46924972.40299243],[18.88945187285865,42.28214938112062,49.41623021983798,28.37526547674683,15.89692645905621,23.20727783962369,17.9821213243984,35.94137282208595,34.63213121496307,37.23990717083655,97.19780204034407,14.24785769793541,43.53713921351699,58.51134478556979,43.14661409264082,33.02468157143679,20.28745270639234,59.01605479112408,26.7033741908827,28.93118465763823,31.23204863825018,31.33140709327867,35.58776890575682,27.20838429739204,48.59308643517672,20.22145922352263,23.63399465441577,43.96427488866318,19.54166887674917,19.25455165844416,36.92441493731032,15.25257579091202,22.49001877121586,24.55399381757186,25.30250982448905,21.08420464673877,15.48524724995812,38.6409137359806,34.43962078070548,31.71565621271768,25.98136937200175,38.20209937805811,20.36794040439268,10.14703901166184,20.43401955283585,19.315049098665,23.15716254247629,8.739489850299265,7.180681075155656,28.32200595898606,17.54380191533639,27.52851974952805,25.88718540334451,29.38038184394739,40.6052947764496,34.66055101998822,25.01079022569327,44.36026073330368,44.8228956609529],[27245695.5346,96528786.73651248,65325600.37441824,72353227.01057509,48444426.12914991,49094947.00742496,4548571,10471281,41006350.46150006,84016820.69772004,323005555.32098,47518626.86447288,52891420.95298003,68029888.4400624,63581445.52608136,1816310,19477856.56556369,90889096.31340007,78477495.84605558,69138393.41601667,20072879,0,15696235,42517450.35742734,94246138.68513334,26388952.2395,52732483.48729998,75470370.57993847,4652887,44374662.28094997,71568022.62588568,3252292,44329810.74949999,106907453.5555287,72957212.97761817,20650715.953,6746169,20436253.35225716,40875645.42561999,68960761.1000167,13370319,28979364.00795718,55058523.82629231,1973523,3331882,7256046,86234319.34502655,11786194.61886495,10819851.7583067,62427161.80228463,41253628.63185558,42532383.14773889,64024339.13422523,55030958.50869992,80046108.51006,40398012.9877786,65842507.34244554,123296526.0292334,42765349.62913997],[28634773.5224,140432596.49125,82926426.38242725,75298456.63735835,60355779.79117834,55934275.58157498,5065375,11155858,47221736.39649998,98785607.44741991,479571829.1836666,64169789.31479991,69750404.89416006,79525581.80713743,70271420.67439994,1981000,19387576.98030463,104449271.3645875,91959620.23392221,76666679.28751659,22959940,0,17436812,52340435.90071821,132936935.9906889,33396037.6495,65884788.31775004,95674306.20151542,5342991,52543576.25422,80798531.72324279,4033788,56703906.84137507,121766413.5658002,84018019.74559987,25722582.36486001,7263048,22365367.63399284,43876298.50472993,82378116.74924171,14690475,30632189.04827852,72117386.44196925,2244858,3900299,7850133,90711086.69328669,12305878.78480999,11294361.48992663,75013076.14448451,55191950.7405112,51279705.33412221,68432290.02830002,63543283.33423997,106460121.266,47367275.66532858,75774027.41955473,182603710.4994833,54022507.0723],[25458811.0954,164274688.4704,91623974.60778171,72236017.97202516,62494173.98202857,56970719.06997502,5130474,11025030,50613817.47184996,107645500.55756,572172659.6657799,69277991.65749988,80857352.62507004,82939805.43678732,71380201.61540619,1941018,17728641.55710917,108642049.53725,94160871.73806658,76836910.87368333,23147118,0,17951292,56082645.8525091,159718112.3648444,36492298.057,72723139.45844999,106171277.3023154,5731940,55446985.08108006,82340566.4702571,4263709,62715632.63242505,123830503.1992428,86952659.43907279,27832995.05106001,7243956,22173429.14445715,43024960.92013998,87262780.27026662,15117734,28704206.59114995,79725357.96659206,2355631,3898012,8493695,86854807.93160011,12078747.91823,11431453.13216666,79899686.52768461,58467902.25265555,52604813.86373346,66584912.14124162,61674550.04629992,120430856.6356134,49553109.51787141,80023707.57023612,215389782.74235,60264176.65931],[27113093.38413334,133745357.2327208,79958667.12154239,73295900.53998619,57098126.63411894,53999980.55299165,4914806.666666667,10884056.33333333,46280634.77661667,96815976.2342333,458250014.7234755,60322135.94559089,67833059.49073671,76831758.56132905,68411022.60529582,1912776,18864691.7009925,101326805.7384125,88199329.27268146,74213994.52573887,22059979,0,17028113,50313510.70355155,128967062.3468889,32092429.31533333,63780137.08783334,92438651.36125644,5242606,50788407.87208334,78235706.9397952,3849929.666666667,54583116.74110004,117501456.7735239,81309297.38743027,24735431.12297334,7084391,21658350.04356905,42592301.61682997,79533886.03984168,14392842.66666667,29438586.54912855,68967089.41161788,2191337.333333333,3710064.333333333,7866624.666666667,87933404.65663779,12056940.44063498,11181888.79346666,72446641.49148458,51637827.20834079,48805634.11519819,66347180.43458895,60082930.62974659,102312362.1372244,45772799.39032619,73880080.77741213,173763339.7570222,52350677.78691665],[27113093.38413334,133745357.2327208,79958667.12154239,73295900.53998619,57098126.63411894,53999980.55299165,4914806.666666667,10884056.33333333,46280634.77661667,96815976.2342333,458250014.7234755,60322135.94559089,67833059.49073671,76831758.56132905,68411022.60529582,1912776,18864691.7009925,101326805.7384125,88199329.27268146,74213994.52573887,22059979,0,17028113,50313510.70355155,128967062.3468889,32092429.31533333,63780137.08783334,92438651.36125644,5242606,50788407.87208334,78235706.9397952,3849929.666666667,54583116.74110004,117501456.7735239,81309297.38743027,24735431.12297334,7084391,21658350.04356905,42592301.61682997,79533886.03984168,14392842.66666667,29438586.54912855,68967089.41161788,2191337.333333333,3710064.333333333,7866624.666666667,87933404.65663779,12056940.44063498,11181888.79346666,72446641.49148458,51637827.20834079,48805634.11519819,66347180.43458895,60082930.62974659,102312362.1372244,45772799.39032619,73880080.77741213,173763339.7570222,52350677.78691665],[4392607.971373021,75615668.79203273,41938112.69590761,21780069.92135707,4541894.241267501,17055870.0255022,2216773.539165186,7918944.769515349,15456388.24768423,41057051.12484993,291739123.133746,6459043.31747049,48827138.21280169,54818057.96235027,24001368.62756177,1190366.334808311,1394148.16216173,67426419.51893979,24705943.66862139,25177602.82401428,11076598.60603978,0,8905164.174859103,12597555.51814847,95307860.80605018,5218547.63095805,12699713.95357798,46672900.22659173,1278878.399820914,13597893.16759301,27975623.96556891,1165663.99081531,17797186.70484922,31739148.39965682,17218318.88750583,8338067.401692759,1274974.46271425,13238753.33220983,26202987.40681423,33513430.13727667,6643224.048431022,15852618.88901175,5856801.307177897,312363.7212982615,577952.1663977143,2186211.700962596,10401953.60915768,568251.472660291,519255.9843870337,15336114.91456839,6935853.03260105,5089596.464641498,11895840.91395262,15599159.57590209,35959429.67271848,22520410.12432361,9789489.778602008,116186454.5634442,31132754.05588675],[18.9184625849386,43.61324048056859,50.32776312449987,28.50254506563352,16.03481587460376,23.65955856944462,18.01406403033332,35.97502095328834,35.1686814413158,38.94495915977305,97.19780204034407,14.41628049041825,44.47536241374625,59.39504742687858,43.322527215602,33.02760298886536,20.27351038655559,59.90694882675457,27.17051628999492,29.34112638704223,31.34475839795374,31.33140709327867,35.66768951215298,27.55519462758021,49.31581203246895,20.38672475023901,23.98870289984106,45.2446591582894,19.56352658597349,19.61187586046915,37.37119263956606,15.27583944323876,22.89333335115631,25.26580645057463,25.75791353520679,21.32198897923444,15.4857456665409,38.79225853758535,34.66982688869037,32.32014285834709,25.99383835859934,38.26945632039034,20.54882047807688,10.14806493568209,20.43887963232732,19.33777337340145,23.24917093233292,8.736985143259254,7.179874481513743,28.70656429740347,17.73542816309857,27.68122907170075,26.04439531346343,29.86928535823171,41.03443187242647,35.07234418957887,25.38103518640672,44.08163485479044,45.91463873467391],[-45.11417610945971,-41.1885975736217,-39.56483204564322,-45.36634901127992,-35.86901307292274,-37.56974101682147,-42.38516887065252,-45.88765276214244,-33.82580453464162,-30.35291796143816,-47.22922689665037,-37.75968120229179,-40.5656557072808,-41.75022531109601,-44.87167252712587,-46.46258052778646,-50.13870019166237,-42.821074372876,-40.6853655594584,-41.68962924629512,-43.89837587169423,null,-44.31318408884611,-37.13039495434897,-44.78626607681282,-35.26798020154431,-36.95490078150824,-37.17268381214674,-41.38377775786778,-37.67286362911991,-41.8065946916648,-40.27433867747285,-39.1883370146939,-39.28416968172498,-37.59937975032609,-36.69564455658937,-47.10858424945631,-43.45768745437375,-44.37796176884212,-41.02224088779022,-46.64490409706224,-45.88769169019933,-35.62969474362437,-46.19818526008105,-44.50640650710682,-43.82210269279238,-44.35749521930785,-48.55236878599008,-47.70322095134121,-38.18514704874305,-37.08736595882424,-36.03015081240079,-42.82009742553546,-35.41922792080033,-43.27968655696165,-40.92663441633873,-32.2865365932978,-47.95742475808239,-33.65418782025455],[505000,1100000,1251000,580000,499900,456300,533333,568000,559000,590000,1700000,715000,860000,961631,995000,500000,437000,715000,949700,715000,412000,500000,346571,850000,1640000,735000,803697.5,1200000,315000,1100000,565020,305000,1426415.5,900000,621566,400000,461043,954000,875000,801362,500000,650000,710000,455000,510000,495000,585000,530000,555000,1125000,544764,470000,542500,550000,1100000,925000,775000,2037302,1186282],[3478,3453,6447,1981,5744,1695,273,470,2889,1774,2635,4158,5818,1400,2666,420,5742,887,2310,1975,639,597,805,2213,3462,2028,2240,8030,2577,1623,1347,2249,2968,2246,3642,4057,2926,1910,857,668,412,908,7438,2294,2270,1766,3896,5225,6630,3171,3605,6188,2614,2938,3614,1300,2739,3029,2120],[655000,1225000,1253687.5,685000,631375,505000,575000,765000,585247,620157,1780000,810000,835000,950000,1080000,660000,545450,947500,999000,775000,570000,685000,585493,975000,1780998,845000,935000,1225000,463185,1170356,600000,360000,1630500,999000,730000,420963,608000,1150000,875000,782075,680000,700000,720000,630500,649000,663438,725000,640000,670000,1365000,660000,629500,750000,670000,1315000,999000,865000,1680000,1158000],[2973,4422,8156,1620,5044,1713,200,345,2614,1836,3252,4356,6832,1529,2826,309,5400,1256,3053,2223,556,436,767,2642,4642,2771,3261,9844,1902,1943,1425,2318,3678,2512,3634,3958,2223,1802,1139,746,339,744,8242,2037,2146,1626,3498,4976,6668,3526,3511,4374,1973,2495,5405,1471,3093,3724,2364]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>Community District<\/th>\n      <th>Area Sq Miles<\/th>\n      <th>Total Transit Stops<\/th>\n      <th>Transit Stop Density<\/th>\n      <th>Total Ridership 2017<\/th>\n      <th>Total Ridership 2018<\/th>\n      <th>Total Ridership 2019<\/th>\n      <th>Mean Precovid<\/th>\n      <th>Avg Ridership Pre<\/th>\n      <th>Ridership Density Precovid<\/th>\n      <th>Accessibility Score Precovid<\/th>\n      <th>Total Ridership 2021<\/th>\n      <th>Total Ridership 2022<\/th>\n      <th>Total Ridership 2023<\/th>\n      <th>Mean Postcovid<\/th>\n      <th>Avg Ridership Post<\/th>\n      <th>Ridership Density Postcovid<\/th>\n      <th>Accessibility Score Postcovid<\/th>\n      <th>Combined Percent Change<\/th>\n      <th>Median Sale Price Precovid<\/th>\n      <th>Sales Pre Covid<\/th>\n      <th>Median Sale Price Postcovid<\/th>\n      <th>Sales Post Covid<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"searching":false,"info":false,"columnDefs":[{"className":"dt-right","targets":[2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23]},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"Community District","targets":1},{"name":"Area Sq Miles","targets":2},{"name":"Total Transit Stops","targets":3},{"name":"Transit Stop Density","targets":4},{"name":"Total Ridership 2017","targets":5},{"name":"Total Ridership 2018","targets":6},{"name":"Total Ridership 2019","targets":7},{"name":"Mean Precovid","targets":8},{"name":"Avg Ridership Pre","targets":9},{"name":"Ridership Density Precovid","targets":10},{"name":"Accessibility Score Precovid","targets":11},{"name":"Total Ridership 2021","targets":12},{"name":"Total Ridership 2022","targets":13},{"name":"Total Ridership 2023","targets":14},{"name":"Mean Postcovid","targets":15},{"name":"Avg Ridership Post","targets":16},{"name":"Ridership Density Postcovid","targets":17},{"name":"Accessibility Score Postcovid","targets":18},{"name":"Combined Percent Change","targets":19},{"name":"Median Sale Price Precovid","targets":20},{"name":"Sales Pre Covid","targets":21},{"name":"Median Sale Price Postcovid","targets":22},{"name":"Sales Post Covid","targets":23}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<details class="code-fold">
<summary>Display Data Table</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>cd_ridership_sales_price_sf <span class="ot">&lt;-</span> cd_ridership_sales_price <span class="sc">|&gt;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    nyc_cd <span class="sc">|&gt;</span> <span class="fu">select</span>(cd_id, geometry),   <span class="co"># only keep geometry from nyc_cd</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Community District"</span> <span class="ot">=</span> <span class="st">"cd_id"</span>)  </span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="explanations-of-variables-calculated-metrics" class="level3">
<h3 class="anchored" data-anchor-id="explanations-of-variables-calculated-metrics">EXPLANATIONS OF VARIABLES &amp; CALCULATED METRICS</h3>
<p>To avoid repetition, the convention of unique column names is explained below. Although in the above table, the calculated statistics are differentiated by pre-COVID and post-COVID.</p>
<ul>
<li><strong>Community District (CDs)</strong>
<ul>
<li>The naming conventions follow an abbreviation of the borough along with a district number. For example, the first observation, QN10, reads Queens District 10. Visit <a href="https://www.nyc.gov/content/planning/pages/resources/datasets/community-districts">NYC Planning</a> for more information.</li>
</ul></li>
<li><strong>Area (Sq Miles)</strong>
<ul>
<li>The Community District shapefile included the geographical boundaries useful for mapping with the area of the region, which was later converted to square miles for easier interpretation.</li>
</ul></li>
<li><strong>Total Transit Stops</strong>
<ul>
<li>Sums the total count of subway, bus, and SIR stations (if applicable) within a CD.</li>
</ul></li>
<li><strong>Transit Stop Density</strong>
<ul>
<li>Calculated by dividing the total transit stops by area (sq miles) to measure spatial accessibility. The results are interpreted as the number of stations per square mile within the specified CD.</li>
</ul></li>
<li><strong>Total Ridership 2018-2019/2021-2023</strong>
<ul>
<li>Sums the total annual ridership of subways, buses, and SIR ridership (if applicable) within CD for each respective year.</li>
</ul></li>
<li><strong>Mean Pre-COVID/Post-COVID</strong>
<ul>
<li>Calculates the mean ridership pre-COVID by taking into account the total ridership from 2017 to 2019.</li>
</ul></li>
<li><strong>Ridership Density Pre-COVID/Post-COVID</strong>
<ul>
<li>Measures the volume of transit usage per square mile, reflecting on ridership demand and transit usage.</li>
</ul></li>
<li><strong>Accessibility Score Pre-COVID/Post-COVID</strong>
<ul>
<li>By taking into account transit stop density and ridership density, an accessibility score metric was calculated to assess its performance on ridership demands being met. A high accessibility score is ideal, indicating there is an abundance of transit stops with high ridership. Moderate scores reflect the intermediate values that could range from a combination of high ridership with low accessibility to low ridership with high accessibility. Merely observing the accessibility score will be harder to distinguish between the two, which is why the two measures were kept for display in the data table. Lastly, a low accessibility score showcases limited transit accessibility and low reliance, suggesting a greater dependence on private transportation.</li>
</ul></li>
<li><strong>Combined Percent Change</strong>
<ul>
<li>Calculates the change in mean ridership pre-COVID and post-COVID.</li>
</ul></li>
<li><strong>Median Sale Price Pre-COVID/Post-COVID</strong>
<ul>
<li>Calculates the median sale price of houses found within the specified CD.</li>
</ul></li>
<li><strong>Sales Pre-COVID/Post-COVID</strong>
<ul>
<li>Number of sales made per CD.</li>
</ul></li>
<li><strong>Geometry</strong>
<ul>
<li>Dimensions and shape of CDs used for mapping and visuals.</li>
</ul></li>
</ul>
</section>
</section>
<section id="findings-visualizations" class="level1">
<h1>FINDINGS &amp; VISUALIZATIONS</h1>
<section id="accessing-ridership" class="level3">
<h3 class="anchored" data-anchor-id="accessing-ridership">Accessing Ridership</h3>
<p>Observing the percent change in ridership between pre-COVID and post-COVID, there is a uniform trend of moderate decline in ridership seen across all community districts. With darker shades of orange emphasizing severity. Note to professor: To address the difference seen in this graph displayed in my individual report versus the final presentation, having dedicated more time to analyze the data post presentation, I acquired more accurate ridership counts in Staten Island for pre-COVID, specifically from bus ridership that initially had been overlooked due to differing naming conventions that have since been addressed. To contextualize the decline in ridership to current events, a plausible explanation is the shift towards working remotely.</p>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. SPATIAL MAPS: PERCENT CHANGE BY COMMUNITY DISTRICT</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>plot_data <span class="ot">&lt;-</span> cd_ridership_sales_price_sf <span class="sc">%&gt;%</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_with</span>(<span class="sc">~</span><span class="fu">str_replace_all</span>(., <span class="st">" "</span>, <span class="st">"_"</span>) <span class="sc">%&gt;%</span> <span class="fu">str_to_lower</span>())</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Define borough colors</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>borough_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"MN"</span> <span class="ot">=</span> <span class="st">"forestgreen"</span>,</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"BK"</span> <span class="ot">=</span> <span class="st">"steelblue"</span>,</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"QN"</span> <span class="ot">=</span> <span class="st">"purple"</span>,</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"BX"</span> <span class="ot">=</span> <span class="st">"red"</span>,</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SI"</span> <span class="ot">=</span> <span class="st">"orange"</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract borough from community_district</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>plot_data <span class="ot">&lt;-</span> plot_data <span class="sc">%&gt;%</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">borough =</span> <span class="fu">str_sub</span>(community_district, <span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plot_data) <span class="sc">+</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> combined_percent_change), <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">size =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient2</span>(</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">low =</span> <span class="st">"#d73027"</span>,</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">mid =</span> <span class="st">"#fee090"</span>, </span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">high =</span> <span class="st">"#1a9850"</span>,</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">midpoint =</span> <span class="sc">-</span><span class="dv">30</span>,</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">70</span>, <span class="dv">10</span>),</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">na.value =</span> <span class="st">"grey80"</span>,</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"% Change"</span>,</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">scale =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Transit Ridership Recovery Map"</span>,</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Darker red indicates larger ridership decline"</span>) <span class="sc">+</span></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">16</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">"gray40"</span>, <span class="at">size =</span> <span class="dv">11</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"right"</span></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p1)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Individual-Report_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="3600"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="pre-covid-linear-model" class="level3">
<h3 class="anchored" data-anchor-id="pre-covid-linear-model">Pre-COVID Linear Model</h3>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate R-squared for Pre-COVID</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>model_pre <span class="ot">&lt;-</span> <span class="fu">lm</span>(median_sale_price_precovid <span class="sc">~</span> accessibility_score_precovid, </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> plot_data <span class="sc">|&gt;</span> <span class="fu">st_drop_geometry</span>())</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co"># p-value: 3.87e-07 indicating there is a statistically significant relationship between pre-COVID accessibility score and median housing sale price</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_pre)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = median_sale_price_precovid ~ accessibility_score_precovid, 
    data = st_drop_geometry(plot_data))

Residuals:
    Min      1Q  Median      3Q     Max 
-488761 -204423  -43868  139518 1072075 

Coefficients:
                             Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)                    308382      86592   3.561 0.000753 ***
accessibility_score_precovid    14807       2581   5.737 3.87e-07 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 286300 on 57 degrees of freedom
Multiple R-squared:  0.366, Adjusted R-squared:  0.3549 
F-statistic: 32.91 on 1 and 57 DF,  p-value: 3.866e-07</code></pre>
</div>
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>r2_pre <span class="ot">&lt;-</span> <span class="fu">summary</span>(model_pre)<span class="sc">$</span>r.squared</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Coefficients table </span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>coef_tbl_pre <span class="ot">&lt;-</span> <span class="fu">tidy</span>(model_pre, <span class="at">conf.int =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p.value =</span> <span class="fu">signif</span>(p.value, <span class="dv">3</span>),</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">estimate =</span> <span class="fu">round</span>(estimate, <span class="dv">1</span>),</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">std.error =</span> <span class="fu">round</span>(std.error, <span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">Term =</span> term,</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">Estimate =</span> estimate,</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>         <span class="st">`</span><span class="at">Std. Error</span><span class="st">`</span> <span class="ot">=</span> std.error,</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>         <span class="st">`</span><span class="at">p-value</span><span class="st">`</span> <span class="ot">=</span> p.value)</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(coef_tbl_pre)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 42%">
<col style="width: 13%">
<col style="width: 16%">
<col style="width: 14%">
<col style="width: 13%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Term</th>
<th style="text-align: right;">Estimate</th>
<th style="text-align: right;">Std. Error</th>
<th style="text-align: right;">statistic</th>
<th style="text-align: right;">p-value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: right;">308381.6</td>
<td style="text-align: right;">86591.6</td>
<td style="text-align: right;">3.561332</td>
<td style="text-align: right;">7.53e-04</td>
</tr>
<tr class="even">
<td style="text-align: left;">accessibility_score_precovid</td>
<td style="text-align: right;">14807.1</td>
<td style="text-align: right;">2581.1</td>
<td style="text-align: right;">5.736724</td>
<td style="text-align: right;">4.00e-07</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="post-covid-linear-model" class="level3">
<h3 class="anchored" data-anchor-id="post-covid-linear-model">Post-COVID Linear Model</h3>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate R-squared for Post-COVID</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>model_post <span class="ot">&lt;-</span> <span class="fu">lm</span>(median_sale_price_postcovid <span class="sc">~</span> accessibility_score_postcovid, </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> plot_data<span class="sc">|&gt;</span><span class="fu">st_drop_geometry</span>())</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co"># p-value: 5.32e-07 indicating there is a statistically significant relationship between post-COVID accessibility score and median housing sale price</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_post)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = median_sale_price_postcovid ~ accessibility_score_postcovid, 
    data = st_drop_geometry(plot_data))

Residuals:
    Min      1Q  Median      3Q     Max 
-346370 -182860  -40478  131813  878962 

Coefficients:
                              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)                     444914      80381   5.535 8.19e-07 ***
accessibility_score_postcovid    13394       2370   5.651 5.32e-07 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 265700 on 57 degrees of freedom
Multiple R-squared:  0.3591,    Adjusted R-squared:  0.3479 
F-statistic: 31.94 on 1 and 57 DF,  p-value: 5.318e-07</code></pre>
</div>
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>r2_post <span class="ot">&lt;-</span> <span class="fu">summary</span>(model_post)<span class="sc">$</span>r.squared</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Coefficients table </span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>coef_tbl_post <span class="ot">&lt;-</span> <span class="fu">tidy</span>(model_post, <span class="at">conf.int =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p.value =</span> <span class="fu">signif</span>(p.value, <span class="dv">3</span>),</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">estimate =</span> <span class="fu">round</span>(estimate, <span class="dv">1</span>),</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">std.error =</span> <span class="fu">round</span>(std.error, <span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">Term =</span> term,</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">Estimate =</span> estimate,</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>         <span class="st">`</span><span class="at">Std. Error</span><span class="st">`</span> <span class="ot">=</span> std.error,</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>         <span class="st">`</span><span class="at">p-value</span><span class="st">`</span> <span class="ot">=</span> p.value)</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(coef_tbl_post, <span class="at">caption =</span> <span class="st">"Pre-COVID Linear Model"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Pre-COVID Linear Model</caption>
<colgroup>
<col style="width: 44%">
<col style="width: 13%">
<col style="width: 16%">
<col style="width: 14%">
<col style="width: 11%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Term</th>
<th style="text-align: right;">Estimate</th>
<th style="text-align: right;">Std. Error</th>
<th style="text-align: right;">statistic</th>
<th style="text-align: right;">p-value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: right;">444913.7</td>
<td style="text-align: right;">80380.8</td>
<td style="text-align: right;">5.535073</td>
<td style="text-align: right;">8e-07</td>
</tr>
<tr class="even">
<td style="text-align: left;">accessibility_score_postcovid</td>
<td style="text-align: right;">13393.6</td>
<td style="text-align: right;">2370.0</td>
<td style="text-align: right;">5.651319</td>
<td style="text-align: right;">5e-07</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. ACCESSIBILITY vs HOUSING PRICES SCATTER</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Pre-COVID plot</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>p2a <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plot_data, <span class="fu">aes</span>(<span class="at">x =</span> accessibility_score_precovid, </span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>                              <span class="at">y =</span> median_sale_price_precovid <span class="sc">/</span> <span class="dv">1000</span>,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>                              <span class="at">color =</span> borough,</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>                              <span class="at">size =</span> mean_precovid <span class="sc">/</span> <span class="dv">1000000</span>)) <span class="sc">+</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">TRUE</span>, <span class="at">color =</span> <span class="st">"gray30"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="cn">Inf</span>, <span class="at">y =</span> <span class="cn">Inf</span>, </span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"R² = "</span>, <span class="fu">round</span>(r2_pre, <span class="dv">3</span>)), </span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>           <span class="at">hjust =</span> <span class="fl">1.1</span>, <span class="at">vjust =</span> <span class="fl">1.5</span>, <span class="at">size =</span> <span class="dv">5</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>, <span class="at">color =</span> <span class="st">"gray20"</span>) <span class="sc">+</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> borough_colors,</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Manhattan"</span>, <span class="st">"Brooklyn"</span>, <span class="st">"Queens"</span>, <span class="st">"Bronx"</span>, <span class="st">"Staten Island"</span>)) <span class="sc">+</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">12</span>), </span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>                        <span class="at">name =</span> <span class="st">"Ridership</span><span class="sc">\n</span><span class="st">(Millions)"</span>) <span class="sc">+</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Pre-COVID (2017-2019)"</span>,</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Accessibility Score"</span>,</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Median Sale Price ($1000s)"</span>,</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Borough"</span>) <span class="sc">+</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"right"</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Post-COVID plot</span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>p2b <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plot_data, <span class="fu">aes</span>(<span class="at">x =</span> accessibility_score_postcovid, </span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>                              <span class="at">y =</span> median_sale_price_postcovid <span class="sc">/</span> <span class="dv">1000</span>,</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>                              <span class="at">color =</span> borough,</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>                              <span class="at">size =</span> mean_postcovid <span class="sc">/</span> <span class="dv">1000000</span>)) <span class="sc">+</span></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">TRUE</span>, <span class="at">color =</span> <span class="st">"gray30"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="cn">Inf</span>, <span class="at">y =</span> <span class="cn">Inf</span>, </span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"R² = "</span>, <span class="fu">round</span>(r2_post, <span class="dv">3</span>)), </span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>           <span class="at">hjust =</span> <span class="fl">1.1</span>, <span class="at">vjust =</span> <span class="fl">1.5</span>, <span class="at">size =</span> <span class="dv">5</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>, <span class="at">color =</span> <span class="st">"gray20"</span>) <span class="sc">+</span></span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> borough_colors,</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Manhattan"</span>, <span class="st">"Brooklyn"</span>, <span class="st">"Queens"</span>, <span class="st">"Bronx"</span>, <span class="st">"Staten Island"</span>)) <span class="sc">+</span></span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">12</span>), </span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>                        <span class="at">name =</span> <span class="st">"Ridership</span><span class="sc">\n</span><span class="st">(Millions)"</span>) <span class="sc">+</span></span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Post-COVID (2021-2023)"</span>,</span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Accessibility Score"</span>,</span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Median Sale Price ($1000s)"</span>,</span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Borough"</span>) <span class="sc">+</span></span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="fu">sprintf</span>(<span class="st">"Each point represents a community district"</span>), </span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">"darkgray"</span>)</span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(p2a, p2b, <span class="at">ncol =</span> <span class="dv">2</span>, </span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a>             <span class="at">top =</span> grid<span class="sc">::</span><span class="fu">textGrob</span>(<span class="st">"Property Values vs Transit Accessibility (Normalized 0-100 Scale)"</span>,</span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">gp =</span> grid<span class="sc">::</span><span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="dv">16</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Individual-Report_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="3600"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. RIDERSHIP vs HOUSING PRICES SCATTER (PRE &amp; POST COVID)</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare data in the format needed for the plots</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>precovid_combined <span class="ot">&lt;-</span> plot_data <span class="sc">|&gt;</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(median_sale_price_precovid), <span class="sc">!</span><span class="fu">is.na</span>(mean_precovid)) <span class="sc">%&gt;%</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    community_district,</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    borough,</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_ridership =</span> mean_precovid,</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">median_sale_price =</span> median_sale_price_precovid,</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">station_count =</span> total_transit_stops</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>postcovid_combined <span class="ot">&lt;-</span> plot_data <span class="sc">|&gt;</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(median_sale_price_postcovid), <span class="sc">!</span><span class="fu">is.na</span>(mean_postcovid)) <span class="sc">%&gt;%</span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>    community_district,</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>    borough,</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_ridership =</span> mean_postcovid,</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">median_sale_price =</span> median_sale_price_postcovid,</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">station_count =</span> total_transit_stops</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate linear models</span></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>model_precovid <span class="ot">&lt;-</span> <span class="fu">lm</span>(median_sale_price <span class="sc">~</span> avg_ridership, <span class="at">data =</span> precovid_combined)</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>model_postcovid <span class="ot">&lt;-</span> <span class="fu">lm</span>(median_sale_price <span class="sc">~</span> avg_ridership, <span class="at">data =</span> postcovid_combined)</span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate R-squared values</span></span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>r2_precovid <span class="ot">&lt;-</span> <span class="fu">summary</span>(model_precovid)<span class="sc">$</span>r.squared</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>r2_postcovid <span class="ot">&lt;-</span> <span class="fu">summary</span>(model_postcovid)<span class="sc">$</span>r.squared</span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Pre-COVID scatter plot with R-squared</span></span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>plot_precovid <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(precovid_combined, </span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">aes</span>(<span class="at">x =</span> avg_ridership <span class="sc">/</span> <span class="fl">1e6</span>, <span class="at">y =</span> median_sale_price <span class="sc">/</span> <span class="fl">1e6</span>)) <span class="sc">+</span></span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> station_count), <span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">color =</span> <span class="st">"#2c7bb6"</span>) <span class="sc">+</span></span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">TRUE</span>, <span class="at">color =</span> <span class="st">"#d7191c"</span>, <span class="at">fill =</span> <span class="st">"#d7191c"</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(</span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a>    <span class="st">"text"</span>,</span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">max</span>(precovid_combined<span class="sc">$</span>avg_ridership <span class="sc">/</span> <span class="fl">1e6</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="fl">0.95</span>,</span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">min</span>(precovid_combined<span class="sc">$</span>median_sale_price <span class="sc">/</span> <span class="fl">1e6</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="fl">1.1</span>,</span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"R² = "</span>, <span class="fu">round</span>(r2_precovid, <span class="dv">3</span>)),</span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust =</span> <span class="dv">1</span>,</span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">vjust =</span> <span class="dv">0</span>,</span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">4</span>,</span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">fontface =</span> <span class="st">"bold"</span>,</span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"#d7191c"</span></span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb26-52"><a href="#cb26-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> comma) <span class="sc">+</span></span>
<span id="cb26-53"><a href="#cb26-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> comma) <span class="sc">+</span></span>
<span id="cb26-54"><a href="#cb26-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb26-55"><a href="#cb26-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Pre-COVID (2017-2019)"</span>,</span>
<span id="cb26-56"><a href="#cb26-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Average Annual Ridership (Millions)"</span>,</span>
<span id="cb26-57"><a href="#cb26-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Median Sale Price (Millions $)"</span>,</span>
<span id="cb26-58"><a href="#cb26-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="st">"Stations"</span></span>
<span id="cb26-59"><a href="#cb26-59" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb26-60"><a href="#cb26-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb26-61"><a href="#cb26-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb26-62"><a href="#cb26-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">13</span>),</span>
<span id="cb26-63"><a href="#cb26-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"right"</span></span>
<span id="cb26-64"><a href="#cb26-64" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb26-65"><a href="#cb26-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-66"><a href="#cb26-66" aria-hidden="true" tabindex="-1"></a><span class="co"># Post-COVID scatter plot with R-squared</span></span>
<span id="cb26-67"><a href="#cb26-67" aria-hidden="true" tabindex="-1"></a>plot_postcovid <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(postcovid_combined, </span>
<span id="cb26-68"><a href="#cb26-68" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">aes</span>(<span class="at">x =</span> avg_ridership <span class="sc">/</span> <span class="fl">1e6</span>, <span class="at">y =</span> median_sale_price <span class="sc">/</span> <span class="fl">1e6</span>)) <span class="sc">+</span></span>
<span id="cb26-69"><a href="#cb26-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> station_count), <span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">color =</span> <span class="st">"#2c7bb6"</span>) <span class="sc">+</span></span>
<span id="cb26-70"><a href="#cb26-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">TRUE</span>, <span class="at">color =</span> <span class="st">"#d7191c"</span>, <span class="at">fill =</span> <span class="st">"#d7191c"</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb26-71"><a href="#cb26-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(</span>
<span id="cb26-72"><a href="#cb26-72" aria-hidden="true" tabindex="-1"></a>    <span class="st">"text"</span>,</span>
<span id="cb26-73"><a href="#cb26-73" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">max</span>(postcovid_combined<span class="sc">$</span>avg_ridership <span class="sc">/</span> <span class="fl">1e6</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="fl">0.95</span>,</span>
<span id="cb26-74"><a href="#cb26-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">min</span>(postcovid_combined<span class="sc">$</span>median_sale_price <span class="sc">/</span> <span class="fl">1e6</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="fl">1.1</span>,</span>
<span id="cb26-75"><a href="#cb26-75" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"R² = "</span>, <span class="fu">round</span>(r2_postcovid, <span class="dv">3</span>)),</span>
<span id="cb26-76"><a href="#cb26-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust =</span> <span class="dv">1</span>,</span>
<span id="cb26-77"><a href="#cb26-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">vjust =</span> <span class="dv">0</span>,</span>
<span id="cb26-78"><a href="#cb26-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">4</span>,</span>
<span id="cb26-79"><a href="#cb26-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">fontface =</span> <span class="st">"bold"</span>,</span>
<span id="cb26-80"><a href="#cb26-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"#d7191c"</span></span>
<span id="cb26-81"><a href="#cb26-81" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb26-82"><a href="#cb26-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> comma) <span class="sc">+</span></span>
<span id="cb26-83"><a href="#cb26-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> comma) <span class="sc">+</span></span>
<span id="cb26-84"><a href="#cb26-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb26-85"><a href="#cb26-85" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Post-COVID (2021-2023)"</span>,</span>
<span id="cb26-86"><a href="#cb26-86" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Average Annual Ridership (Millions)"</span>,</span>
<span id="cb26-87"><a href="#cb26-87" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Median Sale Price (Millions $)"</span>,</span>
<span id="cb26-88"><a href="#cb26-88" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="st">"Stations"</span></span>
<span id="cb26-89"><a href="#cb26-89" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb26-90"><a href="#cb26-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb26-91"><a href="#cb26-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb26-92"><a href="#cb26-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">13</span>),</span>
<span id="cb26-93"><a href="#cb26-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"right"</span></span>
<span id="cb26-94"><a href="#cb26-94" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb26-95"><a href="#cb26-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-96"><a href="#cb26-96" aria-hidden="true" tabindex="-1"></a>combined_scatter <span class="ot">&lt;-</span> plot_precovid <span class="sc">+</span> plot_postcovid <span class="sc">+</span></span>
<span id="cb26-97"><a href="#cb26-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_annotation</span>(</span>
<span id="cb26-98"><a href="#cb26-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Transit Ridership is a Poor Predictor of Property Value"</span>,</span>
<span id="cb26-99"><a href="#cb26-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="fu">sprintf</span>(<span class="st">"Each point represents a community district"</span>), </span>
<span id="cb26-100"><a href="#cb26-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(</span>
<span id="cb26-101"><a href="#cb26-101" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">16</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb26-102"><a href="#cb26-102" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">"darkgray"</span>)</span>
<span id="cb26-103"><a href="#cb26-103" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-104"><a href="#cb26-104" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb26-105"><a href="#cb26-105" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(combined_scatter)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Individual-Report_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="3600"></p>
</figure>
</div>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/tiffany-ngli\.github\.io\/STA9750-2025-FALL\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>